å‚è€ƒï¼š  
[æ‰‹æŠŠæ‰‹æ•™ä½ å¼€å‘ç”Ÿäº§çº§ IM ç³»ç»Ÿ](https://mp.weixin.qq.com/s/_Direcn6tk2P2KDpncFdgQ)  
[ä»é›¶å¼€å§‹æ­å»ºç“œå­ IM ç³»ç»Ÿ](https://mp.weixin.qq.com/s/TUIxcg0EJC0S26gKrKqYKg)  
[ä¸€ä¸ªæµ·é‡åœ¨çº¿ç”¨æˆ·å³æ—¶é€šè®¯ç³»ç»Ÿï¼ˆIMï¼‰çš„å®Œæ•´è®¾è®¡](https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483756&idx=1&sn=a8e3303bc573b1acaf9ef3862ef89bdd&chksm=ea044bf3dd73c2e5dcf2c10202c66d6143ec866205e9230f974fbc0b0be587926699230b6b18#rd)  
[åŸºäºæ¶ˆæ¯æ€»çº¿çš„é«˜å¯æ‰©å±•æ€§ IM ç³»ç»Ÿåå°æ¶æ„è®¾è®¡](https://mp.weixin.qq.com/s/a4sDH48PWTHax2uBej1Jtg)  
[ä½æˆæœ¬ç¡®ä¿æ¶ˆæ¯æ—¶åºçš„æ–¹æ³•](https://mp.weixin.qq.com/s/QtlgYtfek4Sv8Ss5b8ojxA)  
[åˆ«äººè¯»æ²¡è¯»ä½ çš„æ¶ˆæ¯ï¼Œä½ å¦‚ä½•çŸ¥é“ï¼Ÿ](https://mp.weixin.qq.com/s/4URbQUeyTOcm1xtTwfjqUA)  
[ID ç”Ÿæˆç­–ç•¥â€”â€”SnowFlake](https://mp.weixin.qq.com/s/p_cANKSn5hFxHo-YzzYs-A)  
[æ¶æ„æˆé•¿ä¹‹è·¯ï¼š9 ç§é«˜æ€§èƒ½é«˜å¯ç”¨é«˜å¹¶å‘çš„æŠ€æœ¯æ¶æ„](https://www.jianshu.com/p/b067266bbdf4)  
[golang å†™çš„ IM æœåŠ¡å™¨](https://github.com/alberliu/goim)  
[goim v2.0-é«˜æ€§èƒ½èŠå¤©å®¤](https://github.com/Terry-Mao/goim)  
[å¿«é€Ÿè£‚å˜ï¼šè§è¯å¾®ä¿¡å¼ºå¤§åå°æ¶æ„ä» 0 åˆ° 1 çš„æ¼”è¿›å†ç¨‹ï¼ˆä¸€ï¼‰](http://www.52im.net/thread-168-1-1.html)  
[ä»Šæ—¥å¤´æ¡æ¶æ„æ¼”è¿›ä¹‹è·¯â€”â€”é«˜å‹ä¸‹çš„æ¶æ„æ¼”è¿›ä¸“é¢˜](https://www.jianshu.com/p/6c879e132093)  
[å¾®ä¿¡æŠ€æœ¯åˆ†äº«ï¼šå¾®ä¿¡çš„æµ·é‡ IM èŠå¤©æ¶ˆæ¯åºåˆ—å·ç”Ÿæˆå®è·µï¼ˆç®—æ³•åŸç†ç¯‡ï¼‰](http://www.52im.net/thread-1998-1-1.html)

ç‰¹åˆ«æ„Ÿè°¢å…¬ä¼—å·ï¼šæ™®é€šç¨‹åºå‘˜ï¼Œ**å°å®‡**å¤§ç¥çš„ç³»åˆ—IMåˆ†äº«æ–‡ç« ğŸ™ã€‚

# 1 æœåŠ¡ç«¯è®¾è®¡

## 1.1 æ€»ä½“æ¶æ„

![æ¶æ„](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/architecture.png)

## 1.2 é€»è¾‘æ¶æ„

![æ¶æ„](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/architecture2.png)

å®¢æˆ·ç«¯ä»IplistæœåŠ¡è·å–æ¥å…¥å±‚IPåœ°å€ï¼ˆä¹Ÿå¯é‡‡ç”¨åŸŸåçš„æ–¹å¼è§£æå¾—åˆ°æ¥å…¥å±‚IPåœ°å€ï¼‰ï¼Œå»ºç«‹ä¸æ¥å…¥å±‚çš„è¿æ¥ï¼ˆå¯èƒ½ä¸ºçŸ­è¿æ¥ï¼‰ï¼Œä»è€Œå®ç°å®¢æˆ·ç«¯ä¸IMæœåŠ¡å™¨çš„æ•°æ®äº¤äº’ï¼›ä¸šåŠ¡çº¿æœåŠ¡å™¨å¯ä»¥é€šè¿‡æœåŠ¡å™¨ç«¯APIå»ºç«‹ä¸IMæœåŠ¡å™¨çš„è”ç³»ï¼Œå‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼›å®¢æˆ·ç«¯ä¸ŠæŠ¥åˆ°ä¸šåŠ¡æœåŠ¡å™¨çš„æ¶ˆæ¯ï¼ŒIMæœåŠ¡å™¨ä¼šé€šè¿‡mqæŠ•é€’ç»™ä¸šåŠ¡æœåŠ¡å™¨ã€‚

### 1.2.1 ç”¨æˆ·ç«¯

ç§»åŠ¨ç«¯ä»¥ iOS ä¸ºä¸»ï¼Œå…¨éƒ¨ä½¿ç”¨ Swift ç¼–å†™ã€‚åç»­å¢åŠ é¡ºåºå¯èƒ½æ˜¯ï¼šFlutter->Android->WebSocket ç­‰å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä¸»è¦ç”¨æ¥æ¼”ç¤º SDK åŠŸèƒ½ï¼Œåç»­æ ¹æ®åœºæ™¯å¯èƒ½ä¼šè€ƒè™‘å¢åŠ å¦‚ç”µå•†ã€æ•™è‚²ç­‰ demoã€‚

### 1.2.2 ç”¨æˆ·ç«¯ API

é’ˆå¯¹ TCP åè®®ï¼Œæä¾› IOS/Android å¼€å‘ SDKã€‚å¯¹äº H5 é¡µé¢ï¼Œæä¾› WebSocket æ¥å£

### 1.2.3 æ¥å…¥å±‚

æ¥å…¥å±‚ä¸»è¦ä»»åŠ¡æ˜¯ä¿æŒæµ·é‡ç”¨æˆ·è¿æ¥ï¼ˆæ¥å…¥ï¼‰ã€æ”»å‡»é˜²æŠ¤ã€å°†æµ·é‡è¿æ¥æ•´æµæˆå°‘é‡ TCP è¿æ¥ä¸é€»è¾‘å±‚é€šè®¯ã€‚

### 1.2.4 é€»è¾‘å±‚

é€»è¾‘å±‚è´Ÿè´£ IM ç³»ç»Ÿå„é¡¹åŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘å®ç°ã€‚åŒ…æ‹¬å•èŠï¼ˆc2cï¼‰ã€ä¸ŠæŠ¥(c2s)ã€æ¨é€(s2c)ã€ç¾¤èŠ(c2g)ã€ç¦»çº¿æ¶ˆæ¯ã€ç™»å½•æˆæƒã€ç»„ç»‡æœºæ„æ ‘ç­‰ç­‰å†…å®¹ã€‚

### 1.2.5 å­˜å‚¨å±‚

å­˜å‚¨å±‚è´Ÿè´£ç¼“å­˜æˆ–å­˜å‚¨ IM ç³»ç»Ÿç›¸å…³æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·çŠ¶æ€åŠè·¯ç”±ï¼ˆç¼“å­˜ï¼‰ï¼Œæ¶ˆæ¯æ•°æ®ï¼ˆMySQL ä¹Ÿå¯é‡‡ç”¨ NoSqlï¼Œå¦‚ MangoDBï¼‰ï¼Œæ–‡ä»¶æ•°æ®ï¼ˆæ–‡ä»¶æœåŠ¡å™¨ï¼‰ã€‚

## 1.3 æ¨¡å—æ¶æ„

![æ¨¡å—æ¶æ„](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/structure.png)  
é™¤ Router ä¹‹å¤–å…¶ä»–æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€è®¾è®¡ï¼Œå¯ä»¥æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚é€šå¸¸å‰æœŸæ¨èæ¯ä¸ªæœåŠ¡éƒ¨ç½²åŒèŠ‚ç‚¹å†—ä½™ï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚

### 1.3.1 ç™»å½•æˆæƒ(auth)
![ç™»å½•æˆæƒ](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-login.png)  
AppServerï¼šå®¢æˆ·çš„åº”ç”¨æœåŠ¡å™¨ï¼ŒéCoffeeChatæä¾›  

1. ç¬¬ä¸‰æ–¹å¸å·åœ¨ç”¨æˆ·æ³¨å†Œæ—¶é€šè¿‡HTTPæ¥å£å¯¼å…¥åˆ°CoffeeChatå¹³å°ï¼Œä¼ é€’UIDã€æ˜µç§°ï¼ˆç”¨æ¥pushæ¨é€æ—¶æ˜¾ç¤ºçš„æ˜µç§°ï¼‰ã€å¤´åƒURLç­‰ã€‚
2. è¿”å›æ³¨å†Œç»“æœå’Œtokenï¼Œtokenå¯ä»¥åœ¨app_serverå­˜å‚¨ï¼Œç›´åˆ°ç”¨æˆ·ä¿®æ”¹å¯†ç åæ‰è¢«æ›´æ–°ï¼Œä»¥å®ç°è‡ªåŠ¨ç™»å½•ã€‚
3. å®¢æˆ·ç«¯ç™»å½•åº”ç”¨æœåŠ¡å™¨ï¼Œè¿›è¡Œè´¦å·å¯†ç æ ¡éªŒã€‚
4. åº”ç”¨æœåŠ¡å™¨æ ¡éªŒæˆåŠŸåï¼Œå‘msg_logicæŸ¥è¯¢tokenã€‚
5. msg_logicè¿”å›uidå¯¹åº”çš„tokenã€‚
6. å®¢æˆ·ç«¯é€šè¿‡åŸŸåæŸ¥è¯¢åˆ°msg_gateæœåŠ¡å™¨åœ°å€ï¼ˆå®ç°è´Ÿè½½å‡è¡¡ï¼‰ã€‚
7. å®¢æˆ·ç«¯é€šè¿‡tcpè¿æ¥msg_gateåï¼Œä½¿ç”¨uidå’Œtokenå‘èµ·æˆæƒéªŒè¯è¯·æ±‚ï¼Œmsg_gateåŒæ­¥rpcè°ƒç”¨msg_logicã€‚
8. msg_logicéªŒè¯tokenåˆæ³•æ€§ï¼ŒéªŒè¯æˆåŠŸåæŠŠå®¢æˆ·ç«¯çŠ¶æ€è®°å½•åœ¨redisä¸­å¹¶è®¾ç½®ä¸ºåœ¨çº¿ã€‚
9. msg_gateå¾—åˆ°éªŒè¯ç»“æœåï¼Œè®¾ç½®sessionçŠ¶æ€ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›éªŒè¯ç»“æœã€‚

### 1.3.2 ç™»å‡º(logout)
![ç™»å‡º](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-logout.png)  

1. å®¢æˆ·ç«¯å‘msg_gateå‘é€ç™»å‡ºè¯·æ±‚ã€‚
2. msg_gateç»™å®¢æˆ·ç«¯å›å¤å“åº”ã€‚
3. msg_gateé€šçŸ¥msg_logciç”¨æˆ·ç™»å‡ºã€‚

### 1.3.3 è¸¢äºº(kickout)
æš‚ä¸æ”¯æŒã€‚

### 1.3.4 ä¸ŠæŠ¥(c2s)
æš‚ä¸æ”¯æŒã€‚

### 1.3.5 æ¨é€(s2c)
![æ¨é€](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-s2c.png)  

1. ä¸šåŠ¡çº¿è°ƒç”¨pushæ•°æ®æ¥å£sendmsg
2. Logicå‘redisæ£€ç´¢ç›®æ ‡ç”¨æˆ·çŠ¶æ€ã€‚å¦‚æœç›®æ ‡ç”¨æˆ·ä¸åœ¨çº¿ï¼Œä¸¢å¼ƒæ•°æ®ï¼ˆæœªæ¥å¯æ ¹æ®ä¸šåŠ¡åœºæ™¯å®šåˆ¶åŒ–é€»è¾‘ï¼‰ï¼›å¦‚æœç”¨æˆ·åœ¨çº¿ï¼ŒæŸ¥è¯¢åˆ°ç”¨æˆ·è¿æ¥çš„æ¥å…¥å±‚gate
3. Logicå‘ç”¨æˆ·æ‰€åœ¨çš„gateå‘é€æ•°æ®
4. Gateå‘ç”¨æˆ·æ¨é€æ•°æ®ã€‚ï¼ˆå¦‚æœç”¨æˆ·ä¸åœ¨çº¿ï¼Œé€šçŸ¥logicç”¨æˆ·ä¸åœ¨çº¿ï¼‰
5. å®¢æˆ·ç«¯æ”¶åˆ°æ•°æ®åå‘gateå‘é€ackåé¦ˆ
6. Gateå°†ackä¿¡æ¯ä¼ é€’ç»™logicå±‚ï¼Œç”¨äºå…¶ä»–å¯èƒ½çš„é€»è¾‘å¤„ç†ï¼ˆå¦‚æ—¥å¿—ï¼Œç¡®è®¤é€è¾¾ç­‰ï¼‰

### 1.3.6 å•èŠ(c2c)
![å•èŠ](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-c2c.png)  

1. App1å‘gate1å‘é€ä¿¡æ¯ï¼ˆä¿¡æ¯æœ€ç»ˆè¦å‘ç»™App2ï¼‰
2. Gate1å°†ä¿¡æ¯æŠ•é€’ç»™logic
3. Logicæ”¶åˆ°ä¿¡æ¯åï¼Œå°†ä¿¡æ¯è¿›è¡Œå­˜å‚¨
4. å­˜å‚¨æˆåŠŸåï¼Œlogicå‘gate1å‘é€ack
5. Gate1å°†ackä¿¡æ¯å‘ç»™App1
6. Logicæ£€ç´¢redisï¼ŒæŸ¥æ‰¾App2çŠ¶æ€ã€‚å¦‚æœApp2æœªç™»å½•ï¼Œæµç¨‹ç»“æŸ
7. å¦‚æœApp2ç™»å½•åˆ°äº†gate2ï¼Œlogicå°†æ¶ˆæ¯å‘å¾€gate2
8. Gate2å°†æ¶ˆæ¯å‘ç»™App2ï¼ˆå¦‚æœå‘ç°App2ä¸åœ¨çº¿ï¼Œä¸¢å¼ƒæ¶ˆæ¯å³å¯ï¼Œè¿™ç§æ¦‚ç‡æä½ï¼Œåç»­ç¦»çº¿æ¶ˆæ¯å¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼‰
9. App2å‘gate2å‘é€ack
10. Gate2å°†ackä¿¡æ¯å‘ç»™logic
11. Logicå°†æ¶ˆæ¯çŠ¶æ€è®¾ç½®ä¸ºå·²é€è¾¾ã€‚

æ³¨ï¼šåœ¨ç¬¬6æ­¥å’Œç¬¬7æ­¥ä¹‹é—´ï¼Œå¯åŠ¨è®¡æ—¶å™¨ï¼ˆDelayedQueueæˆ–å“ˆå¸Œç¯ï¼Œæ—¶é—´å¦‚5ç§’ï¼‰ï¼Œè®¡æ—¶å™¨æ—¶é—´åˆ°åï¼Œæ¢æµ‹è¯¥æ¡æ¶ˆæ¯çŠ¶æ€ï¼Œå¦‚æœæ¶ˆæ¯æœªé€è¾¾ï¼Œè€ƒè™‘é€šè¿‡APNSã€ç±³æ¨ã€ä¸ªæ¨è¿›è¡Œæ¨é€

### 1.3.7 ç¾¤èŠ(c2g)
é‡‡ç”¨æ‰©æ•£å†™ï¼ˆè€Œéæ‰©æ•£è¯»ï¼‰çš„æ–¹å¼ã€‚  
ç¾¤èŠæ˜¯å¤šäººç¤¾äº¤çš„åŸºæœ¬è¯‰æ±‚ï¼Œä¸€ä¸ªç¾¤å‹åœ¨ç¾¤å†…å‘äº†ä¸€æ¡æ¶ˆæ¯ï¼š  
ï¼ˆ1ï¼‰åœ¨çº¿çš„ç¾¤å‹èƒ½ç¬¬ä¸€æ—¶é—´æ”¶åˆ°æ¶ˆæ¯  
ï¼ˆ2ï¼‰ç¦»çº¿çš„ç¾¤å‹èƒ½åœ¨ç™»é™†åæ”¶åˆ°æ¶ˆæ¯  
ç”±äºâ€œæ¶ˆæ¯é£æš´æ‰©æ•£ç³»æ•°â€çš„å­˜åœ¨ï¼Œç¾¤æ¶ˆæ¯çš„å¤æ‚åº¦è¦è¿œé«˜äºå•å¯¹å•æ¶ˆæ¯ã€‚  
ç¾¤åŸºç¡€è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç¾¤çš„åŸºæœ¬ä¿¡æ¯  
im_group_msgs(group_id, group_name,create_user, owner, announcement, create_time)  
ç¾¤æˆå‘˜è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç¾¤é‡Œæœ‰å¤šå°‘æˆå‘˜  
im_group_users(group_id, user_id)  
ç”¨æˆ·æ¥æ”¶æ¶ˆæ¯è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰æ”¶åˆ°ç¾¤æ¶ˆæ¯ï¼ˆä¸å•å¯¹å•æ¶ˆæ¯è¡¨æ˜¯åŒä¸€ä¸ªè¡¨ï¼‰  
im_message_recieveï¼ˆmsg_id,msg_from,msg_to, group_idï¼Œmsg_seq, msg_content, send_time, msg_type, deliverd, cmd_idï¼‰  
ç”¨æˆ·å‘é€æ¶ˆæ¯è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç”¨æˆ·å‘é€äº†å“ªäº›æ¶ˆæ¯  
im_message_send (msg_id,msg_from,msg_to, group_idï¼Œmsg_seq, msg_content, send_time, msg_type, cmd_id)  
ä¸šåŠ¡åœºæ™¯ä¸¾ä¾‹ï¼š  
ï¼ˆ1ï¼‰ä¸€ä¸ªç¾¤ä¸­æœ‰x,A,B,C,Då…±5ä¸ªæˆå‘˜ï¼Œæˆå‘˜xå‘äº†ä¸€ä¸ªæ¶ˆæ¯  
ï¼ˆ2ï¼‰æˆå‘˜Aä¸Båœ¨çº¿ï¼ŒæœŸæœ›å®æ—¶æ”¶åˆ°æ¶ˆæ¯  
ï¼ˆ3ï¼‰æˆå‘˜Cä¸Dç¦»çº¿ï¼ŒæœŸæœ›æœªæ¥æ‹‰å–åˆ°ç¦»çº¿æ¶ˆæ¯  
ç¾¤èŠæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º  
![ç¾¤èŠ](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-c2g.png)  
1. Xå‘gateå‘é€ä¿¡æ¯ï¼ˆä¿¡æ¯æœ€ç»ˆè¦å‘ç»™è¿™ä¸ªç¾¤ï¼ŒAã€Båœ¨çº¿ï¼‰
2. Gateå°†æ¶ˆæ¯å‘ç»™logic
3. å­˜å‚¨æ¶ˆæ¯åˆ°im_message_sendè¡¨ï¼ŒæŒ‰ç…§msg_fromæ°´å¹³åˆ†åº“
4. å›ack
5. å›ack
6. Logicæ£€ç´¢æ•°æ®åº“ï¼ˆéœ€è¦ä½¿ç”¨ç¼“å­˜ï¼‰ï¼Œè·å¾—ç¾¤æˆå‘˜åˆ—è¡¨
7. å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„æ¶ˆæ¯æ•°æ®ï¼ˆç”¨æˆ·è§†å›¾ï¼‰ï¼ŒæŒ‰ç…§msg_toæ°´å¹³åˆ†åº“(å¹¶å‘ã€æ‰¹é‡å†™å…¥)ã€‚
8. æŸ¥è¯¢ç”¨æˆ·åœ¨çº¿çŠ¶æ€åŠä½ç½®
9. Logicå‘gateæŠ•é€’æ¶ˆæ¯
10. Gateå‘ç”¨æˆ·æŠ•é€’æ¶ˆæ¯
11. Appè¿”å›æ”¶åˆ°æ¶ˆæ¯çš„ackä¿¡æ¯
12. Gateå‘logicä¼ é€’ackä¿¡æ¯
13. å‘ç¼“å­˜ï¼ˆHashï¼‰ä¸­æ›´æ–°æ”¶åˆ°ackçš„æ—¶é—´ã€‚ç„¶ååœ¨é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€å®šæ—¶é—´ï¼Œå°†æ•°æ®æ›´æ–°åˆ°æ•°æ®åº“ï¼ˆæ³¨æ„åªéœ€è¦å†™å…¥æ—¶é—´æ®µå†…æœ‰å˜åŒ–çš„æ•°æ®ï¼‰ã€‚

### 1.3.8 æ‹‰å–ç¦»çº¿æ¶ˆæ¯(pull)

å‚è€ƒæ–‡ç« ï¼ˆåŸºäºTimeLineæ¨¡å‹çš„æ¶ˆæ¯åŒæ­¥æœºåˆ¶ https://mp.weixin.qq.com/s/0eKfIRy8zpCpMrrF15Uiggï¼‰  
ç›®å‰CoffeeChatåŸºäºç®€å•çš„æ¶ˆæ¯åŒæ­¥æ–¹æ³•ï¼š
1. æŠŠæ¶ˆæ¯å­˜å‚¨åˆ°mysql
2. å‘åœ¨çº¿ç”¨æˆ·æ¨é€æ¶ˆæ¯ï¼ˆç¦»çº¿åˆ™èµ°pushé€šé“ï¼‰
3. åœ¨çº¿ç”¨æˆ·è¿”å›æ”¶åˆ°æ¶ˆæ¯çš„ackä¿¡æ¯

å¯¹äºç¦»çº¿ç”¨æˆ·ï¼Œç™»å½•åç›´æ¥æ‹‰å–ç¦»çº¿æ¶ˆæ¯å³å¯ï¼ŒåŒ…å«2éƒ¨åˆ†ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢ä¼šè¯åˆ—è¡¨å’ŒæŒ‰éœ€æ‹‰å–æŸä¸ªä¼šè¯ä¸‹çš„å†å²èŠå¤©è®°å½•ï¼Œåç»­å†è€ƒè™‘å¢åŠ åŸºäºTimeLineæ¨¡å‹çš„æ¶ˆæ¯åŒæ­¥åŠŸèƒ½ã€‚

#### 1ï¼‰æŸ¥è¯¢ä¼šè¯åˆ—è¡¨(session)ï¼ŒåŒ…å«æœªè¯»è®¡æ•°
![ä¼šè¯åˆ—è¡¨](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-session.png)  

1. å®¢æˆ·ç«¯å‘msg_gateè¯·æ±‚ä¼šè¯åˆ—è¡¨ã€‚
2. msg_logicå¼‚æ­¥å¤„ç†æŸ¥è¯¢è¯·æ±‚ï¼Œé€šè¿‡çº¿ç¨‹æ± +æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼ã€‚
3. msg_logicä»mysqlä¸­è·å–ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯åˆ—è¡¨ï¼Œæ¯ä¸ªä¼šè¯å¯¹åº”çš„æœ€æ–°æ¶ˆæ¯idå’Œå†…å®¹ç­‰ã€‚
4. msg_logicä»redisä¸­è¡¥å…¨æ¯ä¸ªä¼šè¯çš„æœªè¯»æ¶ˆæ¯æ•°é‡ã€‚
5. msg_logicå›å¤å“åº”ã€‚
6. msg_gateè½¬å‘å“åº”ç»™å®¢æˆ·ç«¯ã€‚

#### 2ï¼‰æŸ¥è¯¢å†å²æ¶ˆæ¯(msglog)
![å†å²æ¶ˆæ¯](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/seq-msglog.png)  

1. Appç«¯ç™»å½•æˆåŠŸï¼Œç‚¹å‡»æŸä¸ªèŠå¤©åï¼Œå‘IMç³»ç»Ÿå‘èµ·æ‹‰å†å²ç¦»çº¿æ¶ˆæ¯è¯·æ±‚ã€‚ä¼ é€’3ä¸ªä¸»è¦å‚æ•°ï¼Œuidè¡¨æ˜ç”¨æˆ·ï¼›end_msg_idè¡¨æ˜å½“å‰æ”¶åˆ°çš„æœ€å°æ¶ˆæ¯idï¼ˆå¦‚æœæ²¡æ”¶åˆ°è¿‡æ¶ˆæ¯ï¼Œæˆ–æ‹¿ä¸åˆ°æœ€å°æ¶ˆæ¯idåˆ™ä¸º0ï¼‰å³å¯ï¼›limitè¡¨ç¤ºæ¯æ¬¡æ‹‰å–æ¡æ•°ï¼ˆè¿™ä¸ªå€¼ä¹Ÿå¯ä»¥ç”±æœåŠ¡å™¨ç«¯æ§åˆ¶ï¼‰ã€‚
2. end_msg_idä¸º0ï¼ŒæŸ¥è¯¢æœ€æ–°çš„20æ¡æ•°æ®ã€‚
3. im_serveræŸ¥è¯¢ç”¨æˆ·å‰20æ¡ç¦»çº¿æ¶ˆæ¯ã€‚
4. å°†ç¦»çº¿æ¶ˆæ¯æ¨ç»™ç”¨æˆ·ã€‚å‡è®¾è¿™20æ¡ç¦»çº¿æ¶ˆæ¯æœ€åä¸€æ¡ï¼ˆæœ€å°ï¼‰end_msg_id=110ã€‚
5. Appå¾—åˆ°æ•°æ®ï¼Œåˆ¤æ–­å¾—åˆ°çš„æ•°æ®ä¸ä¸ºç©ºï¼ˆæ¶ˆæ¯æ•°ç›®è¿”å›çš„æ•°å€¼ç­‰äºè¯·æ±‚çš„limitï¼‰ï¼Œç»§ç»­å‘èµ·æ‹‰å–æ“ä½œã€‚end_msg_id=110(å–å¾—åˆ°çš„ç¦»çº¿æ¶ˆæ¯ä¸­æœ€åçš„ä¸€æ¡ï¼Œå³IDæœ€å°çš„ä¸€æ¡)ã€‚
6. æ— ã€‚
7. æŸ¥è¯¢end_msg_id<110çš„é’±20æ¡ç¦»çº¿æ•°æ®ã€‚
8. è¿”å›ç»™Appã€‚
9. N-1æŸ¥è¯¢end_msg_id>10çš„ç¦»çº¿æ•°æ®ï¼Œä¸è¶³20æ¡ï¼ˆæ²¡æœ‰ç¦»çº¿æ•°æ®äº†ï¼‰ã€‚ 
10. Nå°†æ•°æ®è¿”å›Appï¼ŒAppåˆ¤æ–­æ‹‰å–ä¸è¶³20æ¡æ•°æ®ï¼Œç»“æŸç¦»çº¿æ‹‰å–è¿‡ç¨‹ã€‚

æ³¨ï¼šä¸Šè¿°æ˜¯æ‹‰å–æ‰€æœ‰èŠå¤©è®°å½•çš„å®Œæ•´è¿‡ç¨‹ï¼Œå®é™…ä¸­æ˜¯æ ¹æ®ç”¨æˆ·æ»‘åŠ¨æ“ä½œæŒ‰éœ€æ‹‰å–çš„ã€‚

## 1.2 æ¨é€å¹³å°

iOSï¼šä½¿ç”¨è‹¹æœå®˜æ–¹çš„ APNS æ¨é€ï¼Œåˆ°è¾¾ç‡æœ‰ä¿éšœ  
Androidï¼š  
ç¬¬ä¸€ç§æ–¹æ¡ˆï¼šæ ¹æ®æ‰‹æœºæ¥é€‰æ‹©å¯¹åº”å‚å•†çš„æ¨é€å¹³å°ï¼Œæ¯”å¦‚åä¸ºã€å°ç±³ã€OVã€é­…æ—ç­‰ï¼Œåˆ°è¾¾ç‡ç›¸å¯¹æœ‰ä¿éšœï¼Œä½†æ˜¯ä¹Ÿä¼šä¸¢ã€‚  
ç¬¬äºŒç§æ–¹æ¡ˆï¼šä¹Ÿå¯ä»¥é€‰æ‹©ç¬¬ä¸‰æ–¹å‚å•†ä¸€é”®æ”¯æŒæ‰€æœ‰æ‰‹æœºï¼Œæ¯”å¦‚æå…‰ã€ç±³æ¨ã€ä¸ªæ¨ï¼Œå…è´¹çš„æ•ˆæœå¾ˆå·®å¹¶ä¸”æœ‰æ¡æ•°é™åˆ¶ã€‚  
ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼šå¯ä»¥é€‰æ‹©çœŸåå°ä¿æ´»æˆ–è€…ç”³è¯·åº”ç”¨ç™½åå•ã€‚  
ä»¥ä¸Šæ–¹æ¡ˆå¯ä»¥ç»“åˆä½¿ç”¨ï¼Œæ€»ä½“è€Œè¨€ï¼Œæ¨é€æ¯”è¾ƒå¤´ç–¼ã€‚å’Œå¾®ä¿¡ã€QQç­‰ä¸èƒ½æ¯”ï¼Œå¾ˆå¤šAPPä¼šå½¼æ­¤å”¤é†’ï¼Œæ‰‹æœºå‚å•†ä¼šé€‰æ‹©æŠŠ2è€…åŠ å…¥ç³»ç»Ÿç™½åå•ç­‰ï¼Œæ‰€ä»¥æ‰æœ‰é‚£ä¹ˆé«˜çš„æ¶ˆæ¯åˆ°è¾¾ç‡ã€‚

# 2 åè®®è®¾è®¡

## 2.1 åè®®ç»„æˆ
imåè®®åŒ…å«åè®®å¤´å’Œæ•°æ®éƒ¨2éƒ¨åˆ†ã€‚åè®®å¤´é€šè¿‡ç»“æ„ä½“ï¼ˆç±»ï¼‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®ç°ï¼Œæ•°æ®éƒ¨ä½¿ç”¨protobufæè¿°ã€‚  
ä¸€ä¸ªIMæ¶ˆæ¯ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿™æ ·çš„ï¼š  
![åè®®ç»„æˆ](https://raw.githubusercontent.com/xmcy0011/CoffeeChat/master/images/other-header.png)  

## 2.2 åè®®å¤´è®¾è®¡
ä»»ä½•æ¶ˆæ¯éƒ½ç”±Headerå’ŒBody2éƒ¨åˆ†ç»„æˆï¼ŒHeaderéƒ¨åˆ†æ˜¯å›ºå®šçš„ï¼Œé•¿åº¦ä¸€å®šæ˜¯16å­—èŠ‚ã€‚è€ŒBodyæ˜¯å¯å˜çš„ï¼Œé€šå¸¸ç”±Headeréƒ¨åˆ†çš„cmd_idå†³å®šå…·ä½“æ˜¯ä»€ä¹ˆå«ä¹‰ã€‚  

```c++
typedef struct {
    uint32_t    length;      // æ— ç¬¦å·4å­—èŠ‚ï¼Œæ•´åŒ…é•¿åº¦=16 + Body.Length()
    uint16_t    version;     // æ— ç¬¦å·2å­—èŠ‚ï¼Œç›®å‰å›ºå®šä¸º1
    uint16_t    flag;        // æ— ç¬¦å·2å­—èŠ‚ï¼Œæ ‡å¿—ä½ï¼ˆé¢„ç•™ï¼‰
    uint16_t    service_id;  // æ— ç¬¦å·2å­—èŠ‚ï¼Œç›®æ ‡æœåŠ¡IDï¼Œä»¥åå¯èƒ½ç”¨ä½œè·¯ç”±ï¼ˆé¢„ç•™ï¼‰
    uint16_t    command_id;  // æ— ç¬¦å·2å­—èŠ‚ï¼Œ0-65535ï¼Œå‘½ä»¤IDï¼Œç”¨äºå¦‚ä½•è§£æbody
    uint16_t    seq_num;  // æ— ç¬¦å·2å­—èŠ‚ï¼Œ0-65535ï¼ŒåŒ…åºå·
    uint16_t    reversed; // æ— ç¬¦å·2å­—èŠ‚ï¼Œä¿ç•™ä½
} CIMHeader_t;
```

## 2.3 æ•°æ®éƒ¨è®¾è®¡

å…·ä½“è§ pb æ–‡ä»¶å¤¹ã€‚  
CIM.Def.protoï¼šæ¶ˆæ¯å’Œæ•°æ®æ¨¡å‹å®šä¹‰  
CIMLogin.protoï¼šç™»å½•è®¤è¯ä¸šåŠ¡ã€‚  
CIMList.protoï¼šåˆ—è¡¨ä¸šåŠ¡ã€‚ä¼šè¯ï¼ˆåŒ…æ‹¬æœªè¯»è®¡æ•°ï¼‰ã€å†å²ç¦»çº¿æ¶ˆæ¯ç­‰  
CIMMessage.protoï¼šæ¶ˆæ¯ä¸šåŠ¡ã€‚æ”¶å‘æ–‡æœ¬ã€å›¾ç‰‡ã€è¡¨æƒ…ã€å£°éŸ³ã€è§†é¢‘ã€æ–‡ä»¶ã€ä½ç½®ç­‰  
### 2.3.1 è®¤è¯æˆæƒ

```protobuf
message CIMAuthTokenReq {
  // cmd id:		0x0101
  required uint64 user_id = 1;
  // CoffeeChatä¸å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œæ¶ˆæ¯æ¨é€æ—¶éœ€è¦æ˜¾ç¤ºæ˜µç§°
  // åŸºäºæµé‡è€ƒè™‘ï¼Œæ˜µç§°ä¸æ”¾åœ¨æ¯æ¡æ¶ˆæ¯ä¸­æºå¸¦
  // ä½†æ˜¯å¦‚æœæœŸé—´ç”¨æˆ·æ›´æ–°æ˜µç§°åï¼Œæ¶ˆæ¯æ¨é€æ˜¾ç¤ºæ˜µç§°ä¼šæœ‰å»¶è¿Ÿï¼ŒCoffeeChatè®¤ä¸ºæ˜¯èƒ½æ¥å—çš„
  required string nick_name = 2;
  required string user_token = 3;
  required CIM.Def.CIMClientType client_type = 4;
  optional string client_version = 5;
}

// ç”¨æˆ·ä¿¡æ¯
message CIMUserInfo {
  required uint64 user_id = 1;
  required string nick_name = 2;    // ç”¨æˆ·æ˜µç§°
  optional string attach_info = 11; // è‡ªå®šä¹‰å­—æ®µ
}

message CIMAuthTokenRsp {
  // cmd id:		0x0102
  required uint32 server_time = 1;              // æœåŠ¡å™¨æ—¶é—´
  required CIM.Def.CIMErrorCode result_code = 2; // éªŒè¯ç»“æœ
  optional string result_string = 3;            // ç»“æœæè¿°
  optional CIM.Def.CIMUserInfo user_info = 4;    // ç”¨æˆ·ä¿¡æ¯
}
```

### 2.3.2 ç™»å‡º

```protobuf
message CIMLogoutReq {
  // cmd id:		0x0103
  required uint64 user_id = 1;
  required CIM.Def.CIMClientType client_type = 2;
}

message CIMLogoutRsp {
  // cmd id:		0x0104
  required uint32 result_code = 1;
}
```

### 2.3.3 å¿ƒè·³
```protobuf
message CIMHeartBeat {
  // cmd id:		0x0105
}
```

### 2.3.4 æ¶ˆæ¯

```protobuf
// å‘é€æ¶ˆæ¯
message IMMsgData {
  // cmd id:		0x0301
  required uint64 from_user_id = 1; // æ¶ˆæ¯å‘é€æ–¹
  required uint64 to_session_id = 2; // æ¶ˆæ¯æ¥å—æ–¹ï¼Œå•èŠç”¨æˆ·IDï¼Œç¾¤èŠç¾¤ID
  required string msg_id = 3;        // å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼Œå”¯ä¸€ï¼ˆUUIDï¼‰
  required uint64 create_time = 4;         // æ¶ˆæ¯åˆ›å»ºæ—¶é—´æˆ³(æ¯«ç§’)
  required CIM.Def.CIMMsgType msg_type = 5; // æ¶ˆæ¯ç±»å‹
  required bytes msg_data = 6;             // æ¶ˆæ¯å†…å®¹
}

// æ¶ˆæ¯é”™è¯¯ç 
enum CIMResCode {
  kCIM_RES_CODE_OK = 0; // ä¸€åˆ‡æ­£å¸¸
  // kCIM_RES_CODE_ERROR = 1;           // é”™è¯¯
  // kCIM_RES_CODE_Group_NOT_EXIST = 2; // ç¾¤ä¸å­˜åœ¨
  // kCIM_RES_CODE_IN_BLACK = 3;        // è¢«æ¥æ”¶æ–¹åŠ å…¥é»‘åå•
}

// ä¼šè¯ç±»å‹
enum CIMSessionType {
  // kCIM_SESSION_TYPE_Invalid = 0;   // æ— æ•ˆä¼šè¯
  kCIM_SESSION_TYPE_SINGLE = 1; // å•èŠ
  kCIM_SESSION_TYPE_GROUP = 2;  // ç¾¤èŠ
  // kCIM_SESSION_TYPE_CHAT_ROOM = 3; // èŠå¤©å®¤
  // kCIM_SESSION_TYPE_CONSULT = 4; // å®¢æœ
}

// æ¶ˆæ¯ç±»å‹
enum CIMMsgType {
  kCIM_MSG_TYPE_TEXT = 1;  // æ–‡æœ¬
  kCIM_MSG_TYPE_IMAGE = 2; // å›¾ç‰‡
  kCIM_MSG_TYPE_Audio = 3; // å£°éŸ³
  // kCIM_MSG_TYPE_VIDEO = 4;        // è§†é¢‘
  // kCIM_MSG_TYPE_LOCATION = 5;     // ä½ç½®
  // kCIM_MSG_TYPE_NOTIFACATION = 6; // ç³»ç»Ÿé€šçŸ¥ï¼ˆåŒ…æ‹¬å…¥ç¾¤å‡ºç¾¤é€šçŸ¥ç­‰ï¼‰
  // kCIM_MSG_TYPE_FILE = 7;         // æ–‡ä»¶
  kCIM_MSG_TYPE_TIPS = 8;  // æé†’ç±»å‹
  kCIM_MSG_TYPE_Robot = 9; // å›¾çµæœºå™¨äººæ¶ˆæ¯

  // kCIM_MSG_TYPE_CUSTOM = 100; // è‡ªå®šä¹‰
  // kCIM_MSG_TYPE_UNKNOWN = 1000; // æœªçŸ¥ç±»å‹æ¶ˆæ¯ï¼Œæœ¬åœ°ä½¿ç”¨ï¼Œå‘é€æ—¶è¯·å‹¿ä½¿ç”¨
}

// æ¶ˆæ¯æ”¶åˆ°å›å¤
message IMMsgDataAck {
  // cmd id:		0x0302
  required uint64 from_user_id = 1;    // æ¶ˆæ¯å‘é€æ–¹
  required uint64 to_session_id = 2; // æ¶ˆæ¯æ¥å—æ–¹ï¼Œå•èŠç”¨æˆ·IDï¼Œç¾¤èŠç¾¤ID
  required string msg_id = 3;     // å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼Œå”¯ä¸€ï¼ˆUUIDï¼‰
  required CIM.Def.CIMResCode res_code = 4;         // é”™è¯¯ç 
  required CIM.Def.CIMSessionType session_type = 5; // ä¼šè¯ç±»å‹
  optional uint64 create_time = 6;                 // åˆ›å»ºæ—¶é—´æˆ³(æ¯«ç§’)
}
```

### 2.3.5 æ‹‰æ¶ˆæ¯
#### 2.3.5.1 æœ€è¿‘èŠå¤©ä¼šè¯åˆ—è¡¨è¯·æ±‚

```protobuf
// æœ€è¿‘èŠå¤©ä¼šè¯åˆ—è¡¨è¯·æ±‚
message CIMRecentContactSessionReq {
  // cmd id:		0x0201
  required uint64 user_id = 1;
  required uint32 latest_update_time = 2; // æœ€åæ›´æ–°æ—¶é—´
}

// ä¼šè¯ä¿¡æ¯
message CIMContactSessionInfo {
  required uint64 session_id = 1;                   // ä¼šè¯id
  required CIMSessionType session_type = 2;         // ä¼šè¯ç±»å‹
  required CIMSessionStatusType session_status = 3; // ä¼šè¯ä¿®æ”¹å‘½ä»¤ï¼Œé¢„ç•™
  required uint32 unread_cnt = 4;     // è¯¥ä¼šè¯æœªè¯»æ¶ˆæ¯æ•°é‡
  required uint32 updated_time = 5;   // æ›´æ–°æ—¶é—´
  required string msg_id = 6;         // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„idï¼ˆUUIDï¼‰
  required uint64 msg_time_stamp = 7; // æœ€æ–°ä¸€æ¡æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
  required bytes msg_data = 8;        // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„å†…å®¹
  required CIMMsgType msg_type = 9;   // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„ç±»å‹
  required uint64 msg_from_user_id = 10; // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„å‘é€è€…
  required CIMMessageStatus msg_status = 11; // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„çŠ¶æ€ï¼ˆé¢„ç•™ï¼‰
  optional string msg_attach = 12;  // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„é™„ä»¶ï¼ˆé¢„ç•™ï¼‰
  optional string extend_data = 13; // æœ¬åœ°æ‰©å±•å­—æ®µï¼ˆé™åˆ¶4096ï¼‰
  optional bool is_robot_session = 14 [ default = false ]; // æ˜¯å¦ä¸ºæœºå™¨äººä¼šè¯
}

message CIMRecentContactSessionRsp {
  // cmd id:		0x0202
  required uint64 user_id = 1;
  required uint32 unread_counts = 2; // æ€»æœªè¯»æ•°é‡
  repeated CIM.Def.CIMContactSessionInfo contact_session_list = 3; // ä¼šè¯åˆ—è¡¨
}
```

#### 2.3.5.2 å†å²ç¦»çº¿æ¶ˆæ¯

```protobuf
message CIMGetMsgListReq {
  // cmd id:		0x0205
  required uint64 user_id = 1;
  required CIM.Def.CIMSessionType session_type = 2;
  required uint64 session_id = 3;
  required uint64 end_msg_id = 4; // ç»“æŸæœåŠ¡å™¨æ¶ˆæ¯id(ä¸åŒ…å«åœ¨æŸ¥è¯¢ç»“æœä¸­)
  required uint32 limit_count = 6; // æœ¬æ¬¡æŸ¥è¯¢æ¶ˆæ¯çš„æ¡æ•°ä¸Šçº¿(æœ€å¤š100æ¡)
}

// æ¶ˆæ¯ä¿¡æ¯
message CIMMsgInfo {
  required string client_msg_id = 1; // å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼ˆUUIDï¼‰
  required uint64 server_msg_id = 2; // æœåŠ¡ç«¯æ¶ˆæ¯ID

  required CIMResCode msg_res_code = 3;       // æ¶ˆæ¯é”™è¯¯ç 
  required CIMMessageFeature msg_feature = 4; // æ¶ˆæ¯å±æ€§
  required CIMSessionType session_type = 5;   // ä¼šè¯ç±»å‹
  required uint64 from_user_id = 6;           // æ¥æºä¼šè¯ID
  required uint64 to_session_id = 7;          // ç›®æ ‡ä¼šè¯ID
  required uint64 create_time = 8; // æ¶ˆæ¯åˆ›å»ºæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

  required CIMMsgType msg_type = 9;               // æ¶ˆæ¯ç±»å‹
  required CIMMessageStatus msg_status = 10;      // æ¶ˆæ¯çŠ¶æ€ï¼ˆé¢„ç•™ï¼‰
  required bytes msg_data = 11;                   // æ¶ˆæ¯å†…å®¹
  optional string attach = 12;                    // æ¶ˆæ¯é™„ä»¶ï¼ˆé¢„ç•™ï¼‰
  required CIMClientType sender_client_type = 13; // å‘é€è€…å®¢æˆ·ç«¯ç±»å‹
}

//å¯¹äºç¾¤è€Œè¨€ï¼Œå¦‚æœæ¶ˆæ¯æ•°ç›®è¿”å›çš„æ•°å€¼å°äºè¯·æ±‚çš„cnt,åˆ™è¡¨ç¤ºç¾¤çš„æ¶ˆæ¯èƒ½æ‹‰å–çš„åˆ°å¤´äº†ï¼Œæ›´æ—©çš„æ¶ˆæ¯æ²¡æœ‰æƒé™æ‹‰å–ã€‚
//å¦‚æœlimit_count å’Œ msg_list.count ä¸ä¸€è‡´ï¼Œè¯´æ˜æœåŠ¡å™¨æ¶ˆæ¯æœ‰ç¼ºå¤±ï¼Œéœ€è¦
//å®¢æˆ·ç«¯åšä¸€ä¸ªç¼ºå¤±æ ‡è®°ï¼Œé¿å…ä¸‹æ¬¡å†æ¬¡æ‹‰å–ã€‚
message CIMGetMsgListRsp {
  // cmd id:		0x0206
  required uint64 user_id = 1;
  required CIM.Def.CIMSessionType session_type = 2;
  required uint64 session_id = 3;
  repeated CIM.Def.CIMMsgInfo msg_list = 6; // æ¶ˆæ¯åˆ—è¡¨
}
```

# 3 å­˜å‚¨è®¾è®¡

## 3.1 mysqlæ•°æ®åº“

MySQLæ•°æ®åº“é‡‡ç”¨utf8mb4ç¼–ç æ ¼å¼ï¼ˆemojiå­—ç¬¦é—®é¢˜ï¼‰
Encoding:UTF-8 Unicode(utf8mb4)
Collation:utf8mb4_general_ci

### 3.1.1 ä¼šè¯è¡¨

```sql
CREATE TABLE `im_session` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL COMMENT 'ç”¨æˆ·id',
  `peer_id` int(11) NOT NULL COMMENT 'å¯¹æ–¹idï¼Œå•èŠä»£è¡¨ç”¨æˆ·ï¼Œç¾¤èŠä»£è¡¨ç¾¤ç»„',
  `session_type` int(11) DEFAULT NULL COMMENT 'ä¼šè¯ç±»å‹ï¼Œ1ï¼šå•èŠï¼Œ2ï¼šç¾¤èŠ',
  `session_status` int(11) DEFAULT NULL COMMENT 'ä¼šè¯ä¿®æ”¹å‘½ä»¤ï¼ˆé¢„ç•™ï¼‰',
  `is_robot_session` tinyint(4) DEFAULT '0' COMMENT 'æ˜¯å¦ä¸ºæœºå™¨äººä¼šè¯ï¼Œ1æ˜¯ï¼Œ0å¦',
  `created` int(11) NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´æˆ³',
  `updated` int(11) NOT NULL COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  PRIMARY KEY (`id`),
  UNIQUE KEY `index` (`user_id`,`peer_id`),
  KEY `idx_userid_peerid_status` (`user_id`,`peer_id`,`session_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.2 å‘é€æ¶ˆæ¯è¡¨

```sql
CREATE TABLE `im_message_send_0` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `msg_id` bigint(20) NOT NULL COMMENT 'æœåŠ¡ç«¯æ¶ˆæ¯ID',
  `client_msg_id` varchar(64) NOT NULL COMMENT 'å®¢æˆ·ç«¯æ¶ˆæ¯ID-UUID',
  `from_id` bigint(11) NOT NULL,
  `to_id` bigint(11) NOT NULL,
  `group_id` bigint(20) DEFAULT NULL,
  `msg_type` int(11) DEFAULT NULL,
  `msg_content` varchar(2048) DEFAULT NULL,
  `msg_res_code` tinyint(4) DEFAULT NULL COMMENT 'æ¶ˆæ¯é”™è¯¯ç  0ï¼šä¸€åˆ‡æ­£å¸¸',
  `msg_feature` tinyint(4) DEFAULT NULL COMMENT 'æ¶ˆæ¯å±æ€§ 0ï¼šé»˜è®¤ 1ï¼šç¦»çº¿æ¶ˆæ¯ 2ï¼šæ¼«æ¸¸æ¶ˆæ¯ 3ï¼šåŒæ­¥æ¶ˆæ¯ 4ï¼šé€ä¼ æ¶ˆæ¯',
  `msg_status` tinyint(4) DEFAULT '0' COMMENT 'æ¶ˆæ¯çŠ¶æ€ 0ï¼šé»˜è®¤ 1ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œæœªè¯» 2ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå·²è¯» 3ï¼šå·²åˆ  4ï¼šå‘é€ä¸­ 5ï¼šå·²å‘é€ 7ï¼šè‰ç¨¿ 8ï¼šå‘é€å–æ¶ˆ 9ï¼šè¢«å¯¹æ–¹æ‹’ç»ï¼Œå¦‚åœ¨é»‘åå•ä¸­',
  `created` int(11) DEFAULT NULL,
  `updated` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.3 æ¥æ”¶æ¶ˆæ¯è¡¨

```sql
CREATE TABLE `im_message_recv_3` (
  `msg_id` bigint(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'æ¶ˆæ¯id',
  `msg_from` varchar(32) NOT NULL DEFAULT '' COMMENT 'å‘é€è€…',
  `msg_to` varchar(32) NOT NULL DEFAULT '' COMMENT 'æ¥æ”¶è€…',
  `group_id` bigint(20) DEFAULT NULL COMMENT 'ç¾¤id',
  `cmd_id` int(11) DEFAULT NULL COMMENT 'tcpåŒ…å¤´å‘½ä»¤id',
  `msg_seq` int(11) DEFAULT NULL COMMENT 'tcpåŒ…å¤´åºåˆ—å·',
  `msg_content` varchar(2048) DEFAULT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `send_time` datetime DEFAULT NULL COMMENT 'æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´',
  `msg_type` int(11) DEFAULT NULL COMMENT 'æ¶ˆæ¯ç±»å‹',
  `delivered` tinyint(4) DEFAULT '0' COMMENT '0ï¼šæœªé€è¾¾ï¼›1ï¼šé€è¾¾',
  PRIMARY KEY (`msg_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.4 ç¾¤ç»„è¡¨

```sql
CREATE TABLE `im_group` (
  `group_id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ç¾¤ç»„id',
  `group_name` varchar(32) NOT NULL DEFAULT '' COMMENT 'ç¾¤å',
  `create_user_id` bigint(20) NOT NULL COMMENT 'åˆ›å»ºè€…id',
  `create_time` int(11) DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `owner` bigint(20) NOT NULL COMMENT 'ç¾¤ä¸»',
  `announcement` varchar(1024) NOT NULL DEFAULT '' COMMENT 'ç¾¤å…¬å‘Š',
  PRIMARY KEY (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.5 ç¾¤æˆå‘˜è¡¨

```sql
CREATE TABLE `im_group_member` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `group_id` bigint(20) NOT NULL COMMENT 'ç¾¤ç»„id',
  `user_id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.6 æ°´å¹³åˆ†åº“
|è¡¨å|æè¿°|æ‹†åˆ†æ–¹å¼|ä¸¾ä¾‹|
|-|-|-|-|
|im_message_send|ç”¨æˆ·å‘é€çš„æ¶ˆæ¯|æŒ‰ç…§hash(msg_from)%4å–æ¨¡ï¼Œæ‹†åˆ†4ä¸ªåº“|im_message_send_0ã€â€¦â€¦ã€im_message_send_3
|im_message_recv|ç”¨æˆ·æ¥æ”¶çš„æ¶ˆæ¯|æŒ‰ç…§hash(msg_to)%4å–æ¨¡ï¼Œæ‹†åˆ†4ä¸ªåº“|im_message_recv_0ã€â€¦â€¦ã€im_message_recv_3|

## 3.2 redisç¼“å­˜