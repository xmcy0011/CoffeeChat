å‚è€ƒï¼š  
[æ‰‹æŠŠæ‰‹æ•™ä½ å¼€å‘ç”Ÿäº§çº§ IM ç³»ç»Ÿ](https://mp.weixin.qq.com/s/_Direcn6tk2P2KDpncFdgQ)  
[ä»é›¶å¼€å§‹æ­å»ºç“œå­ IM ç³»ç»Ÿ](https://mp.weixin.qq.com/s/TUIxcg0EJC0S26gKrKqYKg)  
[ä¸€ä¸ªæµ·é‡åœ¨çº¿ç”¨æˆ·å³æ—¶é€šè®¯ç³»ç»Ÿï¼ˆIMï¼‰çš„å®Œæ•´è®¾è®¡](https://mp.weixin.qq.com/s?__biz=MzI1ODY0NjAwMA==&mid=2247483756&idx=1&sn=a8e3303bc573b1acaf9ef3862ef89bdd&chksm=ea044bf3dd73c2e5dcf2c10202c66d6143ec866205e9230f974fbc0b0be587926699230b6b18#rd)  
[åŸºäºæ¶ˆæ¯æ€»çº¿çš„é«˜å¯æ‰©å±•æ€§ IM ç³»ç»Ÿåå°æ¶æ„è®¾è®¡](https://mp.weixin.qq.com/s/a4sDH48PWTHax2uBej1Jtg)  
[ä½æˆæœ¬ç¡®ä¿æ¶ˆæ¯æ—¶åºçš„æ–¹æ³•](https://mp.weixin.qq.com/s/QtlgYtfek4Sv8Ss5b8ojxA)  
[åˆ«äººè¯»æ²¡è¯»ä½ çš„æ¶ˆæ¯ï¼Œä½ å¦‚ä½•çŸ¥é“ï¼Ÿ](https://mp.weixin.qq.com/s/4URbQUeyTOcm1xtTwfjqUA)  
[ID ç”Ÿæˆç­–ç•¥â€”â€”SnowFlake](https://mp.weixin.qq.com/s/p_cANKSn5hFxHo-YzzYs-A)  
[æ¶æ„æˆé•¿ä¹‹è·¯ï¼š9 ç§é«˜æ€§èƒ½é«˜å¯ç”¨é«˜å¹¶å‘çš„æŠ€æœ¯æ¶æ„](https://www.jianshu.com/p/b067266bbdf4)  
[golang å†™çš„ IM æœåŠ¡å™¨](https://github.com/alberliu/goim)  
[goim v2.0-é«˜æ€§èƒ½èŠå¤©å®¤](https://github.com/Terry-Mao/goim)  
[å¿«é€Ÿè£‚å˜ï¼šè§è¯å¾®ä¿¡å¼ºå¤§åå°æ¶æ„ä» 0 åˆ° 1 çš„æ¼”è¿›å†ç¨‹ï¼ˆä¸€ï¼‰](http://www.52im.net/thread-168-1-1.html)  
[ä»Šæ—¥å¤´æ¡æ¶æ„æ¼”è¿›ä¹‹è·¯â€”â€”é«˜å‹ä¸‹çš„æ¶æ„æ¼”è¿›ä¸“é¢˜](https://www.jianshu.com/p/6c879e132093)  
[å¾®ä¿¡æŠ€æœ¯åˆ†äº«ï¼šå¾®ä¿¡çš„æµ·é‡ IM èŠå¤©æ¶ˆæ¯åºåˆ—å·ç”Ÿæˆå®è·µï¼ˆç®—æ³•åŸç†ç¯‡ï¼‰](http://www.52im.net/thread-1998-1-1.html)

ç‰¹åˆ«æ„Ÿè°¢å…¬ä¼—å·ï¼šæ™®é€šç¨‹åºå‘˜ï¼Œ**å°å®‡**å¤§ç¥çš„ç³»åˆ— IM åˆ†äº«æ–‡ç«  ğŸ™ã€‚

<!-- TOC -->

- [1 æœåŠ¡ç«¯è®¾è®¡](#1-æœåŠ¡ç«¯è®¾è®¡)
    - [1.1 æ€»ä½“æ¶æ„](#11-æ€»ä½“æ¶æ„)
    - [1.2 é€»è¾‘æ¶æ„](#12-é€»è¾‘æ¶æ„)
        - [1.2.1 ç”¨æˆ·ç«¯](#121-ç”¨æˆ·ç«¯)
        - [1.2.2 ç”¨æˆ·ç«¯ API](#122-ç”¨æˆ·ç«¯-api)
        - [1.2.3 æ¥å…¥å±‚](#123-æ¥å…¥å±‚)
        - [1.2.4 é€»è¾‘å±‚](#124-é€»è¾‘å±‚)
        - [1.2.5 å­˜å‚¨å±‚](#125-å­˜å‚¨å±‚)
    - [1.3 æ¨¡å—æ¶æ„](#13-æ¨¡å—æ¶æ„)
        - [1.3.1 ç™»å½•æˆæƒ(auth)](#131-ç™»å½•æˆæƒauth)
        - [1.3.2 ç™»å‡º(logout)](#132-ç™»å‡ºlogout)
        - [1.3.3 è¸¢äºº(kickout)](#133-è¸¢äººkickout)
        - [1.3.4 ä¸ŠæŠ¥(c2s)](#134-ä¸ŠæŠ¥c2s)
        - [1.3.5 æ¨é€(s2c)](#135-æ¨é€s2c)
        - [1.3.6 å•èŠ(c2c)](#136-å•èŠc2c)
            - [ç”¨æˆ·(grpc)](#ç”¨æˆ·grpc)
            - [æœºå™¨äºº](#æœºå™¨äºº)
        - [1.3.7 ç¾¤èŠ(c2g)](#137-ç¾¤èŠc2g)
        - [1.3.8 æ‹‰å–ç¦»çº¿æ¶ˆæ¯(pull)](#138-æ‹‰å–ç¦»çº¿æ¶ˆæ¯pull)
            - [1ï¼‰æŸ¥è¯¢ä¼šè¯åˆ—è¡¨(session)ï¼ŒåŒ…å«æœªè¯»è®¡æ•°](#1æŸ¥è¯¢ä¼šè¯åˆ—è¡¨sessionåŒ…å«æœªè¯»è®¡æ•°)
            - [2ï¼‰æŸ¥è¯¢å†å²æ¶ˆæ¯(msglog)](#2æŸ¥è¯¢å†å²æ¶ˆæ¯msglog)
        - [1.3.9 å·²è¯»å›æ‰§](#139-å·²è¯»å›æ‰§)
        - [1.3.10 æ’¤å›](#1310-æ’¤å›)
        - [1.3.11 éŸ³è§†é¢‘å®æ—¶é€šè¯](#1311-éŸ³è§†é¢‘å®æ—¶é€šè¯)
    - [1.4 æ¨é€å¹³å°](#14-æ¨é€å¹³å°)
- [2 åè®®è®¾è®¡](#2-åè®®è®¾è®¡)
    - [2.1 åè®®ç»„æˆ](#21-åè®®ç»„æˆ)
    - [2.2 åè®®å¤´è®¾è®¡](#22-åè®®å¤´è®¾è®¡)
    - [2.3 æ•°æ®éƒ¨è®¾è®¡](#23-æ•°æ®éƒ¨è®¾è®¡)
        - [2.3.1 è®¤è¯æˆæƒ](#231-è®¤è¯æˆæƒ)
        - [2.3.2 ç™»å‡º](#232-ç™»å‡º)
        - [2.3.3 å¿ƒè·³](#233-å¿ƒè·³)
        - [2.3.4 æ¶ˆæ¯](#234-æ¶ˆæ¯)
            - [æ–‡ä»¶æ¶ˆæ¯](#æ–‡ä»¶æ¶ˆæ¯)
            - [ä½ç½®æ¶ˆæ¯](#ä½ç½®æ¶ˆæ¯)
            - [æœºå™¨äººæ¶ˆæ¯](#æœºå™¨äººæ¶ˆæ¯)
        - [2.3.5 æ‹‰æ¶ˆæ¯](#235-æ‹‰æ¶ˆæ¯)
            - [2.3.5.1 æœ€è¿‘èŠå¤©ä¼šè¯åˆ—è¡¨è¯·æ±‚](#2351-æœ€è¿‘èŠå¤©ä¼šè¯åˆ—è¡¨è¯·æ±‚)
            - [2.3.5.2 å†å²ç¦»çº¿æ¶ˆæ¯](#2352-å†å²ç¦»çº¿æ¶ˆæ¯)
- [3 å­˜å‚¨è®¾è®¡](#3-å­˜å‚¨è®¾è®¡)
    - [3.1 mysql æ•°æ®åº“](#31-mysql-æ•°æ®åº“)
        - [3.1.1 ä¼šè¯è¡¨](#311-ä¼šè¯è¡¨)
        - [3.1.2 å‘é€æ¶ˆæ¯è¡¨](#312-å‘é€æ¶ˆæ¯è¡¨)
        - [3.1.3 æ¥æ”¶æ¶ˆæ¯è¡¨](#313-æ¥æ”¶æ¶ˆæ¯è¡¨)
        - [3.1.4 ç¾¤ç»„è¡¨](#314-ç¾¤ç»„è¡¨)
        - [3.1.5 ç¾¤æˆå‘˜è¡¨](#315-ç¾¤æˆå‘˜è¡¨)
        - [3.1.6 æ°´å¹³åˆ†åº“](#316-æ°´å¹³åˆ†åº“)
    - [3.2 redis ç¼“å­˜](#32-redis-ç¼“å­˜)

<!-- /TOC -->

# 1 æœåŠ¡ç«¯è®¾è®¡

## 1.1 æ€»ä½“æ¶æ„

![æ¶æ„](../images/architecture.png)

## 1.2 é€»è¾‘æ¶æ„

![æ¶æ„](../images/architecture2.png)

å®¢æˆ·ç«¯ä» Iplist æœåŠ¡è·å–æ¥å…¥å±‚ IP åœ°å€ï¼ˆä¹Ÿå¯é‡‡ç”¨åŸŸåçš„æ–¹å¼è§£æå¾—åˆ°æ¥å…¥å±‚ IP åœ°å€ï¼‰ï¼Œå»ºç«‹ä¸æ¥å…¥å±‚çš„è¿æ¥ï¼ˆå¯èƒ½ä¸ºçŸ­è¿æ¥ï¼‰ï¼Œä»è€Œå®ç°å®¢æˆ·ç«¯ä¸ IM æœåŠ¡å™¨çš„æ•°æ®äº¤äº’ï¼›ä¸šåŠ¡çº¿æœåŠ¡å™¨å¯ä»¥é€šè¿‡æœåŠ¡å™¨ç«¯ API å»ºç«‹ä¸ IM æœåŠ¡å™¨çš„è”ç³»ï¼Œå‘å®¢æˆ·ç«¯æ¨é€æ¶ˆæ¯ï¼›å®¢æˆ·ç«¯ä¸ŠæŠ¥åˆ°ä¸šåŠ¡æœåŠ¡å™¨çš„æ¶ˆæ¯ï¼ŒIM æœåŠ¡å™¨ä¼šé€šè¿‡ mq æŠ•é€’ç»™ä¸šåŠ¡æœåŠ¡å™¨ã€‚

### 1.2.1 ç”¨æˆ·ç«¯

ç§»åŠ¨ç«¯ä»¥ iOS ä¸ºä¸»ï¼Œå…¨éƒ¨ä½¿ç”¨ Swift ç¼–å†™ã€‚åç»­å¢åŠ é¡ºåºå¯èƒ½æ˜¯ï¼šFlutter->Android->WebSocket ç­‰å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯ä¸»è¦ç”¨æ¥æ¼”ç¤º SDK åŠŸèƒ½ï¼Œåç»­æ ¹æ®åœºæ™¯å¯èƒ½ä¼šè€ƒè™‘å¢åŠ å¦‚ç”µå•†ã€æ•™è‚²ç­‰ demoã€‚

### 1.2.2 ç”¨æˆ·ç«¯ API

é’ˆå¯¹ TCP åè®®ï¼Œæä¾› IOS/Android å¼€å‘ SDKã€‚å¯¹äº H5 é¡µé¢ï¼Œæä¾› WebSocket æ¥å£

### 1.2.3 æ¥å…¥å±‚

æ¥å…¥å±‚ä¸»è¦ä»»åŠ¡æ˜¯ä¿æŒæµ·é‡ç”¨æˆ·è¿æ¥ï¼ˆæ¥å…¥ï¼‰ã€æ”»å‡»é˜²æŠ¤ã€å°†æµ·é‡è¿æ¥æ•´æµæˆå°‘é‡ TCP è¿æ¥ä¸é€»è¾‘å±‚é€šè®¯ã€‚

### 1.2.4 é€»è¾‘å±‚

é€»è¾‘å±‚è´Ÿè´£ IM ç³»ç»Ÿå„é¡¹åŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘å®ç°ã€‚åŒ…æ‹¬å•èŠï¼ˆc2cï¼‰ã€ä¸ŠæŠ¥(c2s)ã€æ¨é€(s2c)ã€ç¾¤èŠ(c2g)ã€ç¦»çº¿æ¶ˆæ¯ã€ç™»å½•æˆæƒã€ç»„ç»‡æœºæ„æ ‘ç­‰ç­‰å†…å®¹ã€‚

### 1.2.5 å­˜å‚¨å±‚

å­˜å‚¨å±‚è´Ÿè´£ç¼“å­˜æˆ–å­˜å‚¨ IM ç³»ç»Ÿç›¸å…³æ•°æ®ï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·çŠ¶æ€åŠè·¯ç”±ï¼ˆç¼“å­˜ï¼‰ï¼Œæ¶ˆæ¯æ•°æ®ï¼ˆMySQL ä¹Ÿå¯é‡‡ç”¨ NoSqlï¼Œå¦‚ MangoDBï¼‰ï¼Œæ–‡ä»¶æ•°æ®ï¼ˆæ–‡ä»¶æœåŠ¡å™¨ï¼‰ã€‚

## 1.3 æ¨¡å—æ¶æ„

![æ¨¡å—æ¶æ„](../images/structure.png)  
é™¤ Router ä¹‹å¤–å…¶ä»–æœåŠ¡éƒ½æ˜¯æ— çŠ¶æ€è®¾è®¡ï¼Œå¯ä»¥æ”¯æŒåˆ†å¸ƒå¼éƒ¨ç½²ã€‚é€šå¸¸å‰æœŸæ¨èæ¯ä¸ªæœåŠ¡éƒ¨ç½²åŒèŠ‚ç‚¹å†—ä½™ï¼Œä»¥æé«˜å¯ç”¨æ€§ã€‚

> 2020.06.09 æ›´æ–°-------------  
> PSï¼šç›®å‰å¹¶æ²¡æœ‰å®ç°åˆ†å¸ƒå¼éƒ¨ç½²çš„åŠŸèƒ½ã€‚
> logicå¹¿æ’­ç»™gateï¼Œé€šè¿‡MQå®Œæˆï¼Œå‰Šå³°ã€è§£è€¦ã€ååé‡ã€å®æ—¶/ç¦»çº¿ç»Ÿè®¡è®¡ç®—ã€‚

ä»¥ä¸‹æ˜¯åŸºäºMQçš„æ¶æ„ï¼ˆä¸ºä»€ä¹ˆæ˜¯RocketMQï¼Œè§[MQåœ¨IMä¸­çš„å®è·µå’Œé€‰å‹](../docs/06_MQ%e5%9c%a8IM%e4%b8%ad%e7%9a%84%e5%ae%9e%e8%b7%b5.md)ï¼‰ï¼š  
![æ¨¡å—æ¶æ„](../images/structure-v2.png)

ä¸ºä»€ä¹ˆè¦å¼•å…¥MQï¼Ÿä¸ºäº†è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Ÿ
ç­”ï¼šå‡è®¾å•å°gateæœåŠ¡å™¨æ”¯æŒ5ä¸‡ä¸ªç”¨æˆ·åŒæ—¶åœ¨çº¿ï¼Œä¸ºäº†æ”¯æŒ100ä¸‡ä¸ªç”¨æˆ·åŒæ—¶åœ¨çº¿ï¼Œéœ€è¦éƒ¨ç½²20å°gateæœåŠ¡å™¨ã€‚gateä¹‹é—´éœ€è¦ä¸€ç§æœºåˆ¶èƒ½è¿›è¡Œé€šä¿¡ï¼ˆç”¨æˆ·ä¸ä¸€å®šåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šç™»å½•ï¼‰ï¼Œç®€å•ç‚¹æ‰€æœ‰çš„gateéƒ½è¿æ¥ä¸€ä¸ªrouterï¼Œæ¥ä¸­è½¬å¹¿æ’­ã€‚ä½†æ˜¯è¿™æ ·routerå°±å­˜åœ¨å•ç‚¹æ•…éšœäº†ï¼Œæ‰€ä»¥å¼•å…¥MQå°±æ˜¯ä¸ºäº†è§£å†³routerå•ç‚¹ä»¥åŠæ€§èƒ½çš„é—®é¢˜ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæœ‰ä¸€äº›æ•°æ®åˆ†æä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥ä»mqé‡Œé¢æ‹¿æ•°æ®è¿›è¡Œå®æ—¶åˆ†æã€‚

> PSï¼šè§rocketmqåˆ†æ”¯ï¼Œç›®å‰å·²å®ç°logic/gateæ¥å…¥MQï¼Œä»¥åŠjobæœåŠ¡ï¼Œåˆæ­¥éªŒè¯äº†ç™»å½•åœ¨2å°Gateä¸Šçš„ç”¨æˆ·å¯æ”¶å‘æ¶ˆæ¯ã€‚

### 1.3.1 ç™»å½•æˆæƒ(auth)

![ç™»å½•æˆæƒ](../images/seq-login.png)  
AppServerï¼šå®¢æˆ·çš„åº”ç”¨æœåŠ¡å™¨ï¼Œé CoffeeChat æä¾›

1. ç¬¬ä¸‰æ–¹å¸å·åœ¨ç”¨æˆ·æ³¨å†Œæ—¶é€šè¿‡ HTTP æ¥å£å¯¼å…¥åˆ° CoffeeChat å¹³å°ï¼Œä¼ é€’ UIDã€æ˜µç§°ï¼ˆç”¨æ¥ push æ¨é€æ—¶æ˜¾ç¤ºçš„æ˜µç§°ï¼‰ã€å¤´åƒ URL ç­‰ã€‚
2. è¿”å›æ³¨å†Œç»“æœå’Œ tokenï¼Œtoken å¯ä»¥åœ¨ app_server å­˜å‚¨ï¼Œç›´åˆ°ç”¨æˆ·ä¿®æ”¹å¯†ç åæ‰è¢«æ›´æ–°ï¼Œä»¥å®ç°è‡ªåŠ¨ç™»å½•ã€‚
3. å®¢æˆ·ç«¯ç™»å½•åº”ç”¨æœåŠ¡å™¨ï¼Œè¿›è¡Œè´¦å·å¯†ç æ ¡éªŒã€‚
4. åº”ç”¨æœåŠ¡å™¨æ ¡éªŒæˆåŠŸåï¼Œå‘ msg_logic æŸ¥è¯¢ tokenã€‚
5. msg_logic è¿”å› uid å¯¹åº”çš„ tokenã€‚
6. å®¢æˆ·ç«¯é€šè¿‡åŸŸåæŸ¥è¯¢åˆ° msg_gate æœåŠ¡å™¨åœ°å€ï¼ˆå®ç°è´Ÿè½½å‡è¡¡ï¼‰ã€‚
7. å®¢æˆ·ç«¯é€šè¿‡ tcp è¿æ¥ msg_gate åï¼Œä½¿ç”¨ uid å’Œ token å‘èµ·æˆæƒéªŒè¯è¯·æ±‚ï¼Œmsg_gate åŒæ­¥ rpc è°ƒç”¨ msg_logicã€‚
8. msg_logic éªŒè¯ token åˆæ³•æ€§ï¼ŒéªŒè¯æˆåŠŸåæŠŠå®¢æˆ·ç«¯çŠ¶æ€è®°å½•åœ¨ redis ä¸­å¹¶è®¾ç½®ä¸ºåœ¨çº¿ã€‚
9. msg_gate å¾—åˆ°éªŒè¯ç»“æœåï¼Œè®¾ç½® session çŠ¶æ€ï¼Œå¹¶å‘å®¢æˆ·ç«¯è¿”å›éªŒè¯ç»“æœã€‚

### 1.3.2 ç™»å‡º(logout)

![ç™»å‡º](../images/seq-logout.png)

1. å®¢æˆ·ç«¯å‘ msg_gate å‘é€ç™»å‡ºè¯·æ±‚ã€‚
2. msg_gate ç»™å®¢æˆ·ç«¯å›å¤å“åº”ã€‚
3. msg_gate é€šçŸ¥ msg_logci ç”¨æˆ·ç™»å‡ºã€‚

### 1.3.3 è¸¢äºº(kickout)

æš‚ä¸æ”¯æŒã€‚

### 1.3.4 ä¸ŠæŠ¥(c2s)

æš‚ä¸æ”¯æŒã€‚

### 1.3.5 æ¨é€(s2c)

![æ¨é€](../images/seq-s2c.png)

1. ä¸šåŠ¡çº¿è°ƒç”¨ push æ•°æ®æ¥å£ sendmsg
2. Logic å‘ redis æ£€ç´¢ç›®æ ‡ç”¨æˆ·çŠ¶æ€ã€‚å¦‚æœç›®æ ‡ç”¨æˆ·ä¸åœ¨çº¿ï¼Œä¸¢å¼ƒæ•°æ®ï¼ˆæœªæ¥å¯æ ¹æ®ä¸šåŠ¡åœºæ™¯å®šåˆ¶åŒ–é€»è¾‘ï¼‰ï¼›å¦‚æœç”¨æˆ·åœ¨çº¿ï¼ŒæŸ¥è¯¢åˆ°ç”¨æˆ·è¿æ¥çš„æ¥å…¥å±‚ gate
3. Logic å‘ç”¨æˆ·æ‰€åœ¨çš„ gate å‘é€æ•°æ®
4. Gate å‘ç”¨æˆ·æ¨é€æ•°æ®ã€‚ï¼ˆå¦‚æœç”¨æˆ·ä¸åœ¨çº¿ï¼Œé€šçŸ¥ logic ç”¨æˆ·ä¸åœ¨çº¿ï¼‰
5. å®¢æˆ·ç«¯æ”¶åˆ°æ•°æ®åå‘ gate å‘é€ ack åé¦ˆ
6. Gate å°† ack ä¿¡æ¯ä¼ é€’ç»™ logic å±‚ï¼Œç”¨äºå…¶ä»–å¯èƒ½çš„é€»è¾‘å¤„ç†ï¼ˆå¦‚æ—¥å¿—ï¼Œç¡®è®¤é€è¾¾ç­‰ï¼‰

### 1.3.6 å•èŠ(c2c)

#### ç”¨æˆ·(grpc)

![å•èŠ](../images/seq-c2c.png)

1. App1 å‘ gate1 å‘é€ä¿¡æ¯ï¼ˆä¿¡æ¯æœ€ç»ˆè¦å‘ç»™ App2ï¼‰
2. Gate1 å°†ä¿¡æ¯æŠ•é€’ç»™ logic
3. Logic æ”¶åˆ°ä¿¡æ¯åï¼Œå°†ä¿¡æ¯è¿›è¡Œå­˜å‚¨
4. å­˜å‚¨æˆåŠŸåï¼Œlogic å‘ gate1 å‘é€ ack
5. Gate1 å°† ack ä¿¡æ¯å‘ç»™ App1
6. Logic æ£€ç´¢ redisï¼ŒæŸ¥æ‰¾ App2 çŠ¶æ€ã€‚å¦‚æœ App2 æœªç™»å½•ï¼Œæµç¨‹ç»“æŸ
7. å¦‚æœ App2 ç™»å½•åˆ°äº† gate2ï¼Œlogic å°†æ¶ˆæ¯å‘å¾€ gate2
8. Gate2 å°†æ¶ˆæ¯å‘ç»™ App2ï¼ˆå¦‚æœå‘ç° App2 ä¸åœ¨çº¿ï¼Œä¸¢å¼ƒæ¶ˆæ¯å³å¯ï¼Œè¿™ç§æ¦‚ç‡æä½ï¼Œåç»­ç¦»çº¿æ¶ˆæ¯å¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢ï¼‰
9. App2 å‘ gate2 å‘é€ ack
10. Gate2 å°† ack ä¿¡æ¯å‘ç»™ logic
11. Logic å°†æ¶ˆæ¯çŠ¶æ€è®¾ç½®ä¸ºå·²é€è¾¾ã€‚

æ³¨ï¼šåœ¨ç¬¬ 6 æ­¥å’Œç¬¬ 7 æ­¥ä¹‹é—´ï¼Œå¯åŠ¨è®¡æ—¶å™¨ï¼ˆDelayedQueue æˆ–å“ˆå¸Œç¯ï¼Œæ—¶é—´å¦‚ 5 ç§’ï¼‰ï¼Œè®¡æ—¶å™¨æ—¶é—´åˆ°åï¼Œæ¢æµ‹è¯¥æ¡æ¶ˆæ¯çŠ¶æ€ï¼Œå¦‚æœæ¶ˆæ¯æœªé€è¾¾ï¼Œè€ƒè™‘é€šè¿‡ APNSã€ç±³æ¨ã€ä¸ªæ¨è¿›è¡Œæ¨é€

> â€”â€”2020.07.12 æ›´æ–°  

å®é™…ä¸­æœ‰ç‚¹å‡ºå…¥ï¼š
- masteråˆ†æ”¯ï¼ˆå•æœºç‰ˆï¼‰  
ç›®å‰masteråˆ†æ”¯æ˜¯å•æœºç‰ˆæœ¬ï¼Œåªéœ€è¦éƒ¨ç½²gateå’Œlogicï¼Œgateå’Œlogicä¹‹é—´é€šè¿‡gRPCé€šä¿¡ã€‚2msgå’Œ4msgå…¶å®å°±æ˜¯ä¸€ä¸ªå‡½æ•°çš„å…¥å‚æ•°å’Œè¿”å›å€¼ï¼Œä½¿ç”¨gRPCç®€åŒ–äº†ä¸å°‘ã€‚
![å•èŠgRPC](../images/seq-c2c-grpc.png)

- rocketmqåˆ†æ”¯ï¼ˆé›†ç¾¤ç‰ˆï¼‰  
ç›®å‰rocketmqåˆ†æ”¯è¿˜åœ¨å¼€å‘ä¸­ï¼Œå¹¶ä¸”å¯èƒ½ä¸ä¼šå‘å¸ƒã€‚
![å•èŠmq](../images/seq-c2c-mq.png)

#### æœºå™¨äºº

![å•èŠ](../images/seq-c2c-robot.png)

1. App1 å‘ gate1 å‘é€ä¿¡æ¯ï¼ˆä¿¡æ¯æœ€ç»ˆè¦å‘ç»™èŠå¤©æœºå™¨äººï¼Œè·å–å›å¤ï¼‰
2. Gate1 å°†ä¿¡æ¯æŠ•é€’ç»™ logic
3. Logic æ”¶åˆ°ä¿¡æ¯åï¼Œå°†ä¿¡æ¯è¿›è¡Œå­˜å‚¨
4. å­˜å‚¨æˆåŠŸåï¼Œlogic å‘ gate1 å‘é€ ack
5. Gate1 å°† ack ä¿¡æ¯å‘ç»™ App1
6. Gate1 è°ƒç”¨èŠå¤©æœºå™¨äººHTTP API
7. èŠå¤©æœºå™¨äººç»™å‡ºäº†å›å¤
8. Gate1 å°†æœºå™¨äººå›å¤çš„ä¿¡æ¯æŠ•é€’ç»™ logic
9. Logic æ”¶åˆ°ä¿¡æ¯åï¼Œå°†ä¿¡æ¯è¿›è¡Œå­˜å‚¨
10. å­˜å‚¨æˆåŠŸåï¼Œlogic å‘ gate1 å‘é€ ack
11. Gate1 è½¬å‘æœºå™¨äººæ¶ˆæ¯ç»™ App1
12. APP1 æ”¶åˆ°æ¶ˆæ¯å›å¤ ackã€‚

æ³¨1ï¼šç›®å‰ä»…æ”¯æŒæ€çŸ¥æœºå™¨äººï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œé»˜è®¤å»ºäº†å¯¹åº”çš„æœºå™¨äººã€‚å¦‚éœ€æ›´æ¢ï¼Œè¯·è®¿é—®ï¼šhttps://console.ownthink.com/dashboard/settings/42ad915bb184f2bd5eee7df8e7efd102  
æ³¨2ï¼šå‚è€ƒç½‘æ˜“äº‘çš„æœºå™¨äººæ–‡æ¡£ï¼Œå’Œæ™®é€šæ¶ˆæ¯æœ‰æ‰€åŒºåˆ«çš„æ˜¯ï¼Œæœºå™¨äººæ¶ˆæ¯åŒ…å« ä¸Šè¡Œï¼ˆç”¨æˆ·å‘çš„åŸå§‹æ–‡æœ¬ï¼‰ å’Œ ä¸‹è¡Œï¼ˆæœºå™¨äººå›ç­”ï¼‰ã€‚å¯å‚è€ƒï¼šhttps://dev.yunxin.163.com/docs/product/IMå³æ—¶é€šè®¯/äº§å“ä»‹ç»/æ™ºèƒ½å¯¹è¯æœºå™¨äººæœåŠ¡  
æ³¨3ï¼šç›¸æ¯”å’Œç”¨æˆ·çš„å•èŠï¼Œè¿™é‡Œä¸éœ€è¦è®°å½•æ¶ˆæ¯çŠ¶æ€  

### 1.3.7 ç¾¤èŠ(c2g)

é‡‡ç”¨æ‰©æ•£å†™ï¼ˆè€Œéæ‰©æ•£è¯»ï¼‰çš„æ–¹å¼ã€‚  
ç¾¤èŠæ˜¯å¤šäººç¤¾äº¤çš„åŸºæœ¬è¯‰æ±‚ï¼Œä¸€ä¸ªç¾¤å‹åœ¨ç¾¤å†…å‘äº†ä¸€æ¡æ¶ˆæ¯ï¼š  
ï¼ˆ1ï¼‰åœ¨çº¿çš„ç¾¤å‹èƒ½ç¬¬ä¸€æ—¶é—´æ”¶åˆ°æ¶ˆæ¯  
ï¼ˆ2ï¼‰ç¦»çº¿çš„ç¾¤å‹èƒ½åœ¨ç™»é™†åæ”¶åˆ°æ¶ˆæ¯  
ç”±äºâ€œæ¶ˆæ¯é£æš´æ‰©æ•£ç³»æ•°â€çš„å­˜åœ¨ï¼Œç¾¤æ¶ˆæ¯çš„å¤æ‚åº¦è¦è¿œé«˜äºå•å¯¹å•æ¶ˆæ¯ã€‚  
ç¾¤åŸºç¡€è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç¾¤çš„åŸºæœ¬ä¿¡æ¯  
im_group_msgs(group_id, group_name,create_user, owner, announcement, create_time)  
ç¾¤æˆå‘˜è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç¾¤é‡Œæœ‰å¤šå°‘æˆå‘˜  
im_group_users(group_id, user_id)  
ç”¨æˆ·æ¥æ”¶æ¶ˆæ¯è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç”¨æˆ·çš„æ‰€æœ‰æ”¶åˆ°ç¾¤æ¶ˆæ¯ï¼ˆä¸å•å¯¹å•æ¶ˆæ¯è¡¨æ˜¯åŒä¸€ä¸ªè¡¨ï¼‰  
im_message_recieveï¼ˆmsg_id,msg_from,msg_to, group_idï¼Œmsg_seq, msg_content, send_time, msg_type, deliverd, cmd_idï¼‰  
ç”¨æˆ·å‘é€æ¶ˆæ¯è¡¨ï¼šç”¨æ¥æè¿°ä¸€ä¸ªç”¨æˆ·å‘é€äº†å“ªäº›æ¶ˆæ¯  
im_message_send (msg_id,msg_from,msg_to, group_idï¼Œmsg_seq, msg_content, send_time, msg_type, cmd_id)  
ä¸šåŠ¡åœºæ™¯ä¸¾ä¾‹ï¼š  
ï¼ˆ1ï¼‰ä¸€ä¸ªç¾¤ä¸­æœ‰ x,A,B,C,D å…± 5 ä¸ªæˆå‘˜ï¼Œæˆå‘˜ x å‘äº†ä¸€ä¸ªæ¶ˆæ¯  
ï¼ˆ2ï¼‰æˆå‘˜ A ä¸ B åœ¨çº¿ï¼ŒæœŸæœ›å®æ—¶æ”¶åˆ°æ¶ˆæ¯  
ï¼ˆ3ï¼‰æˆå‘˜ C ä¸ D ç¦»çº¿ï¼ŒæœŸæœ›æœªæ¥æ‹‰å–åˆ°ç¦»çº¿æ¶ˆæ¯ï¼ˆåŒæ—¶é€šè¿‡ç³»ç»Ÿçº§æ¨é€é€šé“æ¨é€ç¦»çº¿æ¶ˆæ¯ï¼‰  
ç¾¤èŠæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º  
![ç¾¤èŠ](../images/seq-c2g.png)

1. X å‘ gate å‘é€ä¿¡æ¯ï¼ˆä¿¡æ¯æœ€ç»ˆè¦å‘ç»™è¿™ä¸ªç¾¤ï¼ŒAã€B åœ¨çº¿ï¼‰
2. Gate å°†æ¶ˆæ¯å‘ç»™ logic
3. å­˜å‚¨æ¶ˆæ¯åˆ° im_message_send è¡¨ï¼ŒæŒ‰ç…§ msg_from æ°´å¹³åˆ†åº“
4. å› ack
5. å› ack
6. Logic æ£€ç´¢æ•°æ®åº“ï¼ˆéœ€è¦ä½¿ç”¨ç¼“å­˜ï¼‰ï¼Œè·å¾—ç¾¤æˆå‘˜åˆ—è¡¨
7. å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„æ¶ˆæ¯æ•°æ®ï¼ˆç”¨æˆ·è§†å›¾ï¼‰ï¼ŒæŒ‰ç…§ msg_to æ°´å¹³åˆ†åº“(å¹¶å‘ã€æ‰¹é‡å†™å…¥)ã€‚
8. æŸ¥è¯¢ç”¨æˆ·åœ¨çº¿çŠ¶æ€åŠä½ç½®
9. Logic å‘ gate æŠ•é€’æ¶ˆæ¯
10. Gate å‘ç”¨æˆ·æŠ•é€’æ¶ˆæ¯
11. App è¿”å›æ”¶åˆ°æ¶ˆæ¯çš„ ack ä¿¡æ¯
12. Gate å‘ logic ä¼ é€’ ack ä¿¡æ¯
13. å‘ç¼“å­˜ï¼ˆHashï¼‰ä¸­æ›´æ–°æ”¶åˆ° ack çš„æ—¶é—´ã€‚ç„¶ååœ¨é€šè¿‡ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€å®šæ—¶é—´ï¼Œå°†æ•°æ®æ›´æ–°åˆ°æ•°æ®åº“ï¼ˆæ³¨æ„åªéœ€è¦å†™å…¥æ—¶é—´æ®µå†…æœ‰å˜åŒ–çš„æ•°æ®ï¼‰ã€‚

### 1.3.8 æ‹‰å–ç¦»çº¿æ¶ˆæ¯(pull)

å‚è€ƒæ–‡ç« ï¼ˆåŸºäº TimeLine æ¨¡å‹çš„æ¶ˆæ¯åŒæ­¥æœºåˆ¶ https://mp.weixin.qq.com/s/0eKfIRy8zpCpMrrF15Uiggï¼‰  
ç›®å‰ CoffeeChat åŸºäºç®€å•çš„æ¶ˆæ¯åŒæ­¥æ–¹æ³•ï¼š

1. æŠŠæ¶ˆæ¯å­˜å‚¨åˆ° mysql
2. å‘åœ¨çº¿ç”¨æˆ·æ¨é€æ¶ˆæ¯ï¼ˆç¦»çº¿åˆ™èµ° push é€šé“ï¼‰
3. åœ¨çº¿ç”¨æˆ·è¿”å›æ”¶åˆ°æ¶ˆæ¯çš„ ack ä¿¡æ¯

å¯¹äºç¦»çº¿ç”¨æˆ·ï¼Œç™»å½•åç›´æ¥æ‹‰å–ç¦»çº¿æ¶ˆæ¯å³å¯ï¼ŒåŒ…å« 2 éƒ¨åˆ†ï¼šä¸€æ¬¡æ€§æŸ¥è¯¢ä¼šè¯åˆ—è¡¨å’ŒæŒ‰éœ€æ‹‰å–æŸä¸ªä¼šè¯ä¸‹çš„å†å²èŠå¤©è®°å½•ï¼Œåç»­å†è€ƒè™‘å¢åŠ åŸºäº TimeLine æ¨¡å‹çš„æ¶ˆæ¯åŒæ­¥åŠŸèƒ½ã€‚

#### 1ï¼‰æŸ¥è¯¢ä¼šè¯åˆ—è¡¨(session)ï¼ŒåŒ…å«æœªè¯»è®¡æ•°

![ä¼šè¯åˆ—è¡¨](../images/seq-session.png)

1. å®¢æˆ·ç«¯å‘ msg_gate è¯·æ±‚ä¼šè¯åˆ—è¡¨ã€‚
2. msg_logic å¼‚æ­¥å¤„ç†æŸ¥è¯¢è¯·æ±‚ï¼Œé€šè¿‡çº¿ç¨‹æ± +æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹å¼ã€‚
3. msg_logic ä» mysql ä¸­è·å–ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯åˆ—è¡¨ï¼Œæ¯ä¸ªä¼šè¯å¯¹åº”çš„æœ€æ–°æ¶ˆæ¯ id å’Œå†…å®¹ç­‰ã€‚
4. msg_logic ä» redis ä¸­è¡¥å…¨æ¯ä¸ªä¼šè¯çš„æœªè¯»æ¶ˆæ¯æ•°é‡ã€‚
5. msg_logic å›å¤å“åº”ã€‚
6. msg_gate è½¬å‘å“åº”ç»™å®¢æˆ·ç«¯ã€‚

#### 2ï¼‰æŸ¥è¯¢å†å²æ¶ˆæ¯(msglog)

![å†å²æ¶ˆæ¯](../images/seq-msglog.png)

1. App ç«¯ç™»å½•æˆåŠŸï¼Œç‚¹å‡»æŸä¸ªèŠå¤©åï¼Œå‘ IM ç³»ç»Ÿå‘èµ·æ‹‰å†å²ç¦»çº¿æ¶ˆæ¯è¯·æ±‚ã€‚ä¼ é€’ 3 ä¸ªä¸»è¦å‚æ•°ï¼Œuid è¡¨ç¤ºç”¨æˆ·ï¼›end_msg_id è¡¨ç¤ºå½“å‰æ”¶åˆ°çš„æœ€å°æ¶ˆæ¯ idï¼ˆå¦‚æœæ²¡æ”¶åˆ°è¿‡æ¶ˆæ¯ï¼Œæˆ–æ‹¿ä¸åˆ°æœ€å°æ¶ˆæ¯ id åˆ™ä¸º 0ï¼‰å³å¯ï¼›limit è¡¨ç¤ºæ¯æ¬¡æ‹‰å–æ¡æ•°ï¼ˆè¿™ä¸ªå€¼ä¹Ÿå¯ä»¥ç”±æœåŠ¡å™¨ç«¯æ§åˆ¶ï¼‰ã€‚
2. end_msg_id ä¸º 0ï¼ŒæŸ¥è¯¢æœ€æ–°çš„ 20 æ¡æ•°æ®ã€‚
3. im_server æŸ¥è¯¢ç”¨æˆ·å‰ 20 æ¡ç¦»çº¿æ¶ˆæ¯ã€‚
4. å°†ç¦»çº¿æ¶ˆæ¯æ¨ç»™ç”¨æˆ·ã€‚å‡è®¾è¿™ 20 æ¡ç¦»çº¿æ¶ˆæ¯æœ€åä¸€æ¡ï¼ˆæœ€å°ï¼‰end_msg_id=110ã€‚
5. App å¾—åˆ°æ•°æ®ï¼Œåˆ¤æ–­å¾—åˆ°çš„æ•°æ®ä¸ä¸ºç©ºï¼ˆæ¶ˆæ¯æ•°ç›®è¿”å›çš„æ•°å€¼ç­‰äºè¯·æ±‚çš„ limitï¼‰ï¼Œç»§ç»­å‘èµ·æ‹‰å–æ“ä½œã€‚end_msg_id=110(å–å¾—åˆ°çš„ç¦»çº¿æ¶ˆæ¯ä¸­æœ€åçš„ä¸€æ¡ï¼Œå³ ID æœ€å°çš„ä¸€æ¡)ã€‚
6. æ— ã€‚
7. æŸ¥è¯¢ end_msg_id<110 çš„é’± 20 æ¡ç¦»çº¿æ•°æ®ã€‚
8. è¿”å›ç»™ Appã€‚
9. N-1 æŸ¥è¯¢ end_msg_id>10 çš„ç¦»çº¿æ•°æ®ï¼Œä¸è¶³ 20 æ¡ï¼ˆæ²¡æœ‰ç¦»çº¿æ•°æ®äº†ï¼‰ã€‚
10. N å°†æ•°æ®è¿”å› Appï¼ŒApp åˆ¤æ–­æ‹‰å–ä¸è¶³ 20 æ¡æ•°æ®ï¼Œç»“æŸç¦»çº¿æ‹‰å–è¿‡ç¨‹ã€‚

æ³¨ï¼šä¸Šè¿°æ˜¯æ‹‰å–æ‰€æœ‰èŠå¤©è®°å½•çš„å®Œæ•´è¿‡ç¨‹ï¼Œå®é™…ä¸­æ˜¯æ ¹æ®ç”¨æˆ·æ»‘åŠ¨æ“ä½œæŒ‰éœ€æ‹‰å–çš„ã€‚

è¯´æ˜ï¼š  
- é’ˆå¯¹ç¾¤èŠæ¶ˆæ¯çš„æ‹‰å–ï¼Œéå¸¸ç®€å•ã€‚ç›´æ¥æŒ‰ç…§groupIdåˆ†é¡µæŸ¥è¯¢å³å¯ã€‚  
- å¯¹äºå•èŠæ¶ˆæ¯ï¼Œåªæ£€ç´¢åŒæ–¹çš„å‘é€æ¶ˆæ¯è¡¨ï¼ˆå¯èƒ½ä¸åœ¨ä¸€ä¸ªåˆ†åº“ï¼‰ï¼Œæ¯ä¸ªè¡¨éƒ½æ£€ç´¢å‡º20æ¡è®°å½•ï¼Œç„¶åä½¿ç”¨æ‹‰é“¾æ³•èšåˆï¼Œè¿”å›æœ€è¿‘çš„20æ¡è®°å½•å³å¯ã€‚
```go
// è®¡ç®—a å’Œ b å‘é€æ¶ˆæ¯è¡¨çš„åå­—ï¼ˆå–ä½™æ•°ï¼Œæ‹¼æ¥è¡¨åå­—ï¼‰
tableNameA := fmt.Sprintf("im_message_send_%d",userId%kIMMessageTableCount)
tableNameB := fmt.Sprintf("im_message_send_%d",sessionId%kIMMessageTableCount)

// æŸ¥è¯¢Aå‘é€çš„æ¶ˆæ¯
sql = fmt.Sprintf("select msg_id,client_msg_id,from_id,to_id,group_id,msg_type,msg_content,"+
				"msg_res_code,msg_feature,msg_status,created,updated from %s"+
				" force index(ix_fromId_toId_msgStatus_created)"+
				" where from_id=%d and to_id=%d"+
				" order by msg_id desc,created limit %d",
        tableNameA, userId, sessionId, limitCount)

// æŸ¥è¯¢Bå‘é€çš„æ¶ˆæ¯
sql = fmt.Sprintf("select msg_id,client_msg_id,from_id,to_id,group_id,msg_type,msg_content,"+
  "msg_res_code,msg_feature,msg_status,created,updated from %s"+
  " force index(ix_fromId_toId_msgStatus_created)"+
  " where from_id=%d and to_id=%d"+
  " order by msg_id desc,created limit %d",
  tableNameB, sessionId, userId, limitCount)

// â€¦â€¦çœç•¥è¯»å–çš„æ­¥éª¤

// ä»å°åˆ°å¤§å‡åºæ’åºï¼ˆæœ€æ–°æ¶ˆæ¯æ”¾æœ€åï¼Œç¬¦åˆè‡ªç„¶æµè§ˆé¡ºåºï¼‰
sort.Slice(msgArr, func(i, j int) bool {
  //return msgArr[i].Created < msgArr[j].Created && msgArr[i].MsgId < msgArr[j].MsgId
  // fixed 2020.01.11 å¯¹è¯é¡ºåºé—®é¢˜
  return msgArr[i].MsgId < msgArr[j].MsgId
})

// è¿”å›éƒ¨åˆ†å‰20æ¡
if len(msgArr) > int(limitCount) {
  return msgArr[len(msgArr)-int(limitCount):], nil
} else {
  return msgArr, nil
}
```


### 1.3.9 å·²è¯»å›æ‰§

### 1.3.10 æ’¤å›

### 1.3.11 éŸ³è§†é¢‘å®æ—¶é€šè¯
![éŸ³è§†é¢‘](../images/architecture_voice_video_call.png)

ä¸ºä»€ä¹ˆéœ€è¦è‡ªå·±å®ç°ä¿¡ä»¤ï¼Ÿ
æ€è€ƒï¼š
å®ç°ç±»å¾®ä¿¡è¯­éŸ³é€šè¯å¦‚ä½•çŸ¥é“æœ‰ç”¨æˆ·è¯­éŸ³å‘¼å«æˆ‘ï¼Ÿ
Agora RTC SDKçš„APIæ–‡æ¡£ä¸­æœ‰onUserJoinedã€onUserOffline2ä¸ªå›è°ƒï¼Œå‰è€…æ˜¯å½“æˆ‘åœ¨é¢‘é“å†…æ—¶ï¼Œå¦‚æœæœ‰æŸä¸ªç”¨æˆ·åŠ å…¥æ—¶è§¦å‘ã€‚é‚£æˆ‘ä½œä¸ºè¢«å‘¼å«æ–¹ï¼ˆå³æœ‰xxé‚€è¯·æˆ‘åŠ å…¥xxé¢‘é“ï¼‰ï¼ŒSDKä¸­æ˜¯å¦æœ‰ç›¸å…³æ¥å£ï¼Œç›‘å¬æœ‰äººé‚€è¯·æˆ‘åŠ å…¥æŸé¢‘é“ï¼Ÿ

> å®˜æ–¹ç­”å¤ï¼š
> ä½ å¥½ï¼Œ
> 
> è¿™éƒ¨åˆ†éœ€è¦é›†æˆä¿¡ä»¤é…åˆå®ç°çš„å“¦ã€‚
> Agora RTC SDK æä¾›çš„æ˜¯å®æ—¶è§†é¢‘/è¯­éŸ³é€šè¯åŠŸèƒ½ï¼Œè€Œè§†é¢‘å‘¼å«é‚€è¯·å±äºä¿¡ä»¤ç³»ç»Ÿçš„åŠŸèƒ½ä¹‹ä¸€ã€‚
> æ‚¨å¯ä»¥é€šè¿‡åŒæ—¶é›†æˆ Agora RTC SDK å’Œ Agora RTM SDK æ¥å®ç°å‘¼å«é‚€è¯·çš„åŠŸèƒ½ã€‚
> è¯·å‚è€ƒç›¸å…³ API æ–‡æ¡£ï¼šhttps://docs.agora.io/cn/Real-time-Messaging/API%20Reference/RTM_java/index.html#callinvitation
> è§†é¢‘å‘¼å«é‚€è¯· Demoï¼šhttps://github.com/AgoraIO/Advanced-Video/tree/master/Video-Call-with-Chat
> 
> å½“åŒæ–¹éƒ½åœ¨çº¿æ—¶ï¼Œè¢«å«å¯é€šè¿‡ acceptRemoteinvitation æ–¹æ³•æ¥å—æ¥è‡ªå¯¹æ–¹çš„å‘¼å«é‚€è¯·ï¼›å½“è¢«å«ä¸åœ¨çº¿æ—¶ï¼ŒSDK ä¼šåœ¨è¢«å«ä¸åœ¨çº¿æ—¶ä¸æ–­é‡å‘å‘¼å«é‚€è¯·ã€‚è‹¥æ¶ˆæ¯å‘é€ 30ç§’åè¢«å«ä»æœªä¸Šçº¿ï¼ŒSDK ä¼šè¿”å› LOCAL_INVITATION_ERR_PEER_OFFLINE é”™è¯¯ç ã€‚Agora RTM SDK æš‚ä¸æ”¯æŒç¦»çº¿æ¨é€åŠŸèƒ½ã€‚éœ€è¦é›†æˆç¬¬ä¸‰æ–¹ä¿¡ä»¤æ¥å®ç°æ¨é€åŠŸèƒ½ã€‚
> 
> æˆ–è€…æ‚¨ä¹Ÿå¯ä»¥é›†æˆç¬¬ä¸‰æ–¹ä¿¡ä»¤ç³»ç»Ÿï¼Œä¾‹å¦‚èäº‘ã€ç¯ä¿¡ç­‰ï¼Œå®ç°å‘¼å«é‚€è¯·ç›¸å…³ä¸šåŠ¡åœºæ™¯ã€‚

æ•…è¯­éŸ³ã€è§†é¢‘å‘¼å«å±äºä¿¡ä»¤çš„åŠŸèƒ½éƒ¨åˆ†ï¼ŒAgora RTC SDKæ²¡æœ‰æä¾›ï¼Œé™¤éå†ä½¿ç”¨åˆ«äººçš„IM SDKã€‚æ‰€ä»¥ï¼Œè¿™éƒ¨åˆ†éœ€è¦æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œä¹Ÿæ˜¯å·¥ä½œé‡ç‚¹å’Œéš¾ç‚¹ä¹‹ä¸€ã€‚

æ›´å¤šä¿¡æ¯è¯·å‚è€ƒï¼šhttp://note.youdao.com/noteshare?id=c74cc984f5bca943fde0c9287a046f64

## 1.4 æ¨é€å¹³å°

iOSï¼šä½¿ç”¨è‹¹æœå®˜æ–¹çš„ APNS æ¨é€ï¼Œåˆ°è¾¾ç‡æœ‰ä¿éšœ  
Androidï¼š  
ç¬¬ä¸€ç§æ–¹æ¡ˆï¼šæ ¹æ®æ‰‹æœºæ¥é€‰æ‹©å¯¹åº”å‚å•†çš„æ¨é€å¹³å°ï¼Œæ¯”å¦‚åä¸ºã€å°ç±³ã€OVã€é­…æ—ç­‰ï¼Œåˆ°è¾¾ç‡ç›¸å¯¹æœ‰ä¿éšœï¼Œä½†æ˜¯ä¹Ÿä¼šä¸¢ã€‚  
ç¬¬äºŒç§æ–¹æ¡ˆï¼šä¹Ÿå¯ä»¥é€‰æ‹©ç¬¬ä¸‰æ–¹å‚å•†ä¸€é”®æ”¯æŒæ‰€æœ‰æ‰‹æœºï¼Œæ¯”å¦‚æå…‰ã€ç±³æ¨ã€ä¸ªæ¨ï¼Œå…è´¹çš„æ•ˆæœå¾ˆå·®å¹¶ä¸”æœ‰æ¡æ•°é™åˆ¶ã€‚  
ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼šå¯ä»¥é€‰æ‹©çœŸåå°ä¿æ´»æˆ–è€…ç”³è¯·åº”ç”¨ç™½åå•ã€‚  
ä»¥ä¸Šæ–¹æ¡ˆå¯ä»¥ç»“åˆä½¿ç”¨ï¼Œæ€»ä½“è€Œè¨€ï¼Œæ¨é€æ¯”è¾ƒå¤´ç–¼ã€‚å’Œå¾®ä¿¡ã€QQ ç­‰ä¸èƒ½æ¯”ï¼Œå¾ˆå¤š APP ä¼šå½¼æ­¤å”¤é†’ï¼Œæ‰‹æœºå‚å•†ä¼šé€‰æ‹©æŠŠ 2 è€…åŠ å…¥ç³»ç»Ÿç™½åå•ç­‰ï¼Œæ‰€ä»¥æ‰æœ‰é‚£ä¹ˆé«˜çš„æ¶ˆæ¯åˆ°è¾¾ç‡ã€‚

# 2 åè®®è®¾è®¡

## 2.1 åè®®ç»„æˆ

im åè®®åŒ…å«åè®®å¤´å’Œæ•°æ®éƒ¨ 2 éƒ¨åˆ†ã€‚åè®®å¤´é€šè¿‡ç»“æ„ä½“ï¼ˆç±»ï¼‰åºåˆ—åŒ–å’Œååºåˆ—åŒ–å®ç°ï¼Œæ•°æ®éƒ¨ä½¿ç”¨ protobuf æè¿°ã€‚  
ä¸€ä¸ª IM æ¶ˆæ¯ï¼Œåœ¨å†…å­˜ä¸­æ˜¯è¿™æ ·çš„ï¼š  
![åè®®ç»„æˆ](../images/other-header.png)

## 2.2 åè®®å¤´è®¾è®¡

ä»»ä½•æ¶ˆæ¯éƒ½ç”± Header å’Œ Body2 éƒ¨åˆ†ç»„æˆï¼ŒHeader éƒ¨åˆ†æ˜¯å›ºå®šçš„ï¼Œé•¿åº¦ä¸€å®šæ˜¯ 16 å­—èŠ‚ã€‚è€Œ Body æ˜¯å¯å˜çš„ï¼Œé€šå¸¸ç”± Header éƒ¨åˆ†çš„ cmd_id å†³å®šå…·ä½“æ˜¯ä»€ä¹ˆå«ä¹‰ã€‚

```c++
typedef struct {
    uint32_t    length;      // æ— ç¬¦å·4å­—èŠ‚ï¼Œæ•´åŒ…é•¿åº¦=16 + Body.Length()
    uint16_t    version;     // æ— ç¬¦å·2å­—èŠ‚ï¼Œç›®å‰å›ºå®šä¸º1
    uint16_t    flag;        // æ— ç¬¦å·2å­—èŠ‚ï¼Œæ ‡å¿—ä½ï¼ˆé¢„ç•™ï¼‰
    uint16_t    service_id;  // æ— ç¬¦å·2å­—èŠ‚ï¼Œç›®æ ‡æœåŠ¡IDï¼Œä»¥åå¯èƒ½ç”¨ä½œè·¯ç”±ï¼ˆé¢„ç•™ï¼‰
    uint16_t    command_id;  // æ— ç¬¦å·2å­—èŠ‚ï¼Œ0-65535ï¼Œå‘½ä»¤IDï¼Œç”¨äºå¦‚ä½•è§£æbody
    uint16_t    seq_num;  // æ— ç¬¦å·2å­—èŠ‚ï¼Œ0-65535ï¼ŒåŒ…åºå·
    uint16_t    reversed; // æ— ç¬¦å·2å­—èŠ‚ï¼Œä¿ç•™ä½
} CIMHeader_t;
```

## 2.3 æ•°æ®éƒ¨è®¾è®¡

å…·ä½“è§ pb æ–‡ä»¶å¤¹ã€‚  
CIM.Def.protoï¼šæ¶ˆæ¯å’Œæ•°æ®æ¨¡å‹å®šä¹‰  
CIMLogin.protoï¼šç™»å½•è®¤è¯ä¸šåŠ¡ã€‚  
CIMList.protoï¼šåˆ—è¡¨ä¸šåŠ¡ã€‚ä¼šè¯ï¼ˆåŒ…æ‹¬æœªè¯»è®¡æ•°ï¼‰ã€å†å²ç¦»çº¿æ¶ˆæ¯ç­‰  
CIMMessage.protoï¼šæ¶ˆæ¯ä¸šåŠ¡ã€‚æ”¶å‘æ–‡æœ¬ã€å›¾ç‰‡ã€è¡¨æƒ…ã€å£°éŸ³ã€è§†é¢‘ã€æ–‡ä»¶ã€ä½ç½®ç­‰

### 2.3.1 è®¤è¯æˆæƒ

```protobuf
message CIMAuthTokenReq {
  // cmd id:		0x0101
  required uint64 user_id = 1;
  // CoffeeChatä¸å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œæ¶ˆæ¯æ¨é€æ—¶éœ€è¦æ˜¾ç¤ºæ˜µç§°
  // åŸºäºæµé‡è€ƒè™‘ï¼Œæ˜µç§°ä¸æ”¾åœ¨æ¯æ¡æ¶ˆæ¯ä¸­æºå¸¦
  // ä½†æ˜¯å¦‚æœæœŸé—´ç”¨æˆ·æ›´æ–°æ˜µç§°åï¼Œæ¶ˆæ¯æ¨é€æ˜¾ç¤ºæ˜µç§°ä¼šæœ‰å»¶è¿Ÿï¼ŒCoffeeChatè®¤ä¸ºæ˜¯èƒ½æ¥å—çš„
  required string nick_name = 2;
  required string user_token = 3;
  required CIM.Def.CIMClientType client_type = 4;
  optional string client_version = 5;
}

// ç”¨æˆ·ä¿¡æ¯
message CIMUserInfo {
  required uint64 user_id = 1;
  required string nick_name = 2;    // ç”¨æˆ·æ˜µç§°
  optional string attach_info = 11; // è‡ªå®šä¹‰å­—æ®µ
}

message CIMAuthTokenRsp {
  // cmd id:		0x0102
  required uint32 server_time = 1;              // æœåŠ¡å™¨æ—¶é—´
  required CIM.Def.CIMErrorCode result_code = 2; // éªŒè¯ç»“æœ
  optional string result_string = 3;            // ç»“æœæè¿°
  optional CIM.Def.CIMUserInfo user_info = 4;    // ç”¨æˆ·ä¿¡æ¯
}
```

### 2.3.2 ç™»å‡º

```protobuf
message CIMLogoutReq {
  // cmd id:		0x0103
  required uint64 user_id = 1;
  required CIM.Def.CIMClientType client_type = 2;
}

message CIMLogoutRsp {
  // cmd id:		0x0104
  required uint32 result_code = 1;
}
```

### 2.3.3 å¿ƒè·³

```protobuf
message CIMHeartBeat {
  // cmd id:		0x0105
}
```

### 2.3.4 æ¶ˆæ¯

```protobuf
// å‘é€æ¶ˆæ¯
message IMMsgData {
  // cmd id:		0x0301
  required uint64 from_user_id = 1; // æ¶ˆæ¯å‘é€æ–¹
  required uint64 to_session_id = 2; // æ¶ˆæ¯æ¥å—æ–¹ï¼Œå•èŠç”¨æˆ·IDï¼Œç¾¤èŠç¾¤ID
  required string msg_id = 3;        // å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼Œå”¯ä¸€ï¼ˆUUIDï¼‰
  required uint64 create_time = 4;         // æ¶ˆæ¯åˆ›å»ºæ—¶é—´æˆ³(æ¯«ç§’)
  required CIM.Def.CIMMsgType msg_type = 5; // æ¶ˆæ¯ç±»å‹
  required bytes msg_data = 6;             // æ¶ˆæ¯å†…å®¹
}

// æ¶ˆæ¯é”™è¯¯ç 
enum CIMResCode {
  kCIM_RES_CODE_OK = 0; // ä¸€åˆ‡æ­£å¸¸
  // kCIM_RES_CODE_ERROR = 1;           // é”™è¯¯
  // kCIM_RES_CODE_Group_NOT_EXIST = 2; // ç¾¤ä¸å­˜åœ¨
  // kCIM_RES_CODE_IN_BLACK = 3;        // è¢«æ¥æ”¶æ–¹åŠ å…¥é»‘åå•
}

// ä¼šè¯ç±»å‹
enum CIMSessionType {
  // kCIM_SESSION_TYPE_Invalid = 0;   // æ— æ•ˆä¼šè¯
  kCIM_SESSION_TYPE_SINGLE = 1; // å•èŠ
  kCIM_SESSION_TYPE_GROUP = 2;  // ç¾¤èŠ
  // kCIM_SESSION_TYPE_CHAT_ROOM = 3; // èŠå¤©å®¤
  // kCIM_SESSION_TYPE_CONSULT = 4; // å®¢æœ
}

// æ¶ˆæ¯ç±»å‹
enum CIMMsgType {
  kCIM_MSG_TYPE_TEXT = 1;  // æ–‡æœ¬
  kCIM_MSG_TYPE_IMAGE = 2; // å›¾ç‰‡
  kCIM_MSG_TYPE_Audio = 3; // å£°éŸ³
  // kCIM_MSG_TYPE_VIDEO = 4;        // è§†é¢‘
  // kCIM_MSG_TYPE_LOCATION = 5;     // ä½ç½®
  // kCIM_MSG_TYPE_NOTIFACATION = 6; // ç³»ç»Ÿé€šçŸ¥ï¼ˆåŒ…æ‹¬å…¥ç¾¤å‡ºç¾¤é€šçŸ¥ç­‰ï¼‰
  // kCIM_MSG_TYPE_FILE = 7;         // æ–‡ä»¶
  kCIM_MSG_TYPE_TIPS = 8;  // æé†’ç±»å‹
  kCIM_MSG_TYPE_Robot = 9; // å›¾çµæœºå™¨äººæ¶ˆæ¯

  // kCIM_MSG_TYPE_CUSTOM = 100; // è‡ªå®šä¹‰
  // kCIM_MSG_TYPE_UNKNOWN = 1000; // æœªçŸ¥ç±»å‹æ¶ˆæ¯ï¼Œæœ¬åœ°ä½¿ç”¨ï¼Œå‘é€æ—¶è¯·å‹¿ä½¿ç”¨
}

// æ¶ˆæ¯æ”¶åˆ°å›å¤
message IMMsgDataAck {
  // cmd id:		0x0302
  required uint64 from_user_id = 1;    // æ¶ˆæ¯å‘é€æ–¹
  required uint64 to_session_id = 2; // æ¶ˆæ¯æ¥å—æ–¹ï¼Œå•èŠç”¨æˆ·IDï¼Œç¾¤èŠç¾¤ID
  required string msg_id = 3;     // å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼Œå”¯ä¸€ï¼ˆUUIDï¼‰
  required CIM.Def.CIMResCode res_code = 4;         // é”™è¯¯ç 
  required CIM.Def.CIMSessionType session_type = 5; // ä¼šè¯ç±»å‹
  optional uint64 create_time = 6;                 // åˆ›å»ºæ—¶é—´æˆ³(æ¯«ç§’)
}
```

#### æ–‡ä»¶æ¶ˆæ¯

IMMsgData.msg_dataä¸ºjsonæ ¼å¼ï¼Œéœ€è¦äºŒæ¬¡è§£æã€‚
1. æ–‡ä»¶
```json
{
  "md5":"e10adc3949ba59abbe56e057f20f883e",         # md5,32ä½
  "size":"1024123",                                 # æ–‡ä»¶å¤§å°,B
  "url":"http://file.qiniu.com/15923014023.pdf",    # ä¸Šä¼ äº‘ç«¯åå¾—åˆ°çš„æ–‡ä»¶ä¸‹è½½åœ°å€
  "displayName":"test.pdf",                         # æ–‡ä»¶æ˜¾ç¤ºåç§°
  "fileExtension":"pdf",                            # æ–‡ä»¶æ‰©å±•å
  "icoThumbUrl":"http://file.qiniu.com/1124.png"    # ä¸Šä¼ äº‘ç«¯åå¾—åˆ°çš„æ–‡ä»¶å›¾æ ‡url
}
```

2. è¯­éŸ³
```json
{
  "md5":"e10adc3949ba59abbe56e057f20f883e",         # md5,32ä½
  "size":"1024123",                                 # æ–‡ä»¶å¤§å°,B
  "url":"http://file.qiniu.com/15923014023.mp3",    # ä¸Šä¼ äº‘ç«¯åå¾—åˆ°çš„æ–‡ä»¶ä¸‹è½½åœ°å€
  "displayName":"test.mp3",                         # æ–‡ä»¶æ˜¾ç¤ºåç§°
  "fileExtension":"pdf",                            # æ–‡ä»¶æ‰©å±•å
  "duration":"120"                                  # æ—¶é•¿ï¼Œç§’
}
```

3. è§†é¢‘
```json
{
  "md5":"e10adc3949ba59abbe56e057f20f883e",         # md5,32ä½
  "size":"1024123",                                 # æ–‡ä»¶å¤§å°,B
  "url":"http://file.qiniu.com/15923014023.mp4",    # ä¸Šä¼ äº‘ç«¯åå¾—åˆ°çš„æ–‡ä»¶ä¸‹è½½åœ°å€
  "displayName":"test.mp4",                         # æ–‡ä»¶æ˜¾ç¤ºåç§°
  "fileExtension":"mp4",                            # æ–‡ä»¶æ‰©å±•å
  "duration":"15",                                  # è§†é¢‘æ—¶é•¿ï¼Œç§’
  "width":"1080",                                   # è§†é¢‘ç”»é¢å®½åº¦
  "height":"1920",                                  # è§†é¢‘ç”»é¢é«˜åº¦
  "thumbUrl":"http://file.qiniu.com/1124.png"       # ä¸Šä¼ äº‘ç«¯åå¾—åˆ°çš„è§†é¢‘å°é¢å›¾ç‰‡url
}
```

#### ä½ç½®æ¶ˆæ¯

åæ ‡ç³»ï¼š
- WGS84ï¼šå›½é™…åæ ‡ç³»ï¼Œä¸ºä¸€ç§å¤§åœ°åæ ‡ç³»ï¼Œä¹Ÿæ˜¯ç›®å‰å¹¿æ³›ä½¿ç”¨çš„GPSå…¨çƒå«æ˜Ÿå®šä½ç³»ç»Ÿä½¿ç”¨çš„åæ ‡ç³»ã€‚Googleåœ°å›¾
- GCJ02ï¼šç«æ˜Ÿåæ ‡ç³»ï¼Œæ˜¯ç”±ä¸­å›½å›½å®¶æµ‹ç»˜å±€åˆ¶è®¢çš„åœ°ç†ä¿¡æ¯ç³»ç»Ÿçš„åæ ‡ç³»ç»Ÿã€‚ç”±WGS84åæ ‡ç³»ç»åŠ å¯†åçš„åæ ‡ç³»ã€‚é«˜å¾·ã€è…¾è®¯ã€Googleä¸­å›½åœ°å›¾ã€æœæœä¸­å›½åœ°å›¾
- BD09ï¼šä¸ºç™¾åº¦åæ ‡ç³»ï¼Œåœ¨GCJ02åæ ‡ç³»åŸºç¡€ä¸Šå†æ¬¡åŠ å¯†ã€‚å…¶ä¸­bd09llè¡¨ç¤ºç™¾åº¦ç»çº¬åº¦åæ ‡ï¼Œbd09mcè¡¨ç¤ºç™¾åº¦å¢¨å¡æ‰˜ç±³åˆ¶åæ ‡ã€‚ç™¾åº¦åœ°å›¾
- å…¶ä»–ï¼šæœç‹—åæ ‡ï¼ˆåœ¨GCJ02åŸºç¡€ä¸ŠåŠ å¯†è€Œæˆçš„ï¼‰ã€å›¾å§åæ ‡ï¼ˆåœ¨GCJ02åŸºç¡€ä¸ŠåŠ å¯†è€Œæˆçš„ï¼‰ã€åŒ—äº¬54åæ ‡ç³»ã€è¥¿å®‰80åæ ‡ç³»

```json
{
  "latitude":"31.301844",                         # çº¬åº¦
  "longitude":"121.513257",                       # ç»åº¦
  "coordinate":"GCJ02",                           # åæ ‡ç³»
  "address":"ä¸Šæµ·å¸‚é»„æµ¦åŒºç¦å·è·¯465å·ä¸–çºªå‡ºç‰ˆå¤§å¦",     # åœ°å€
  "poi":"ä¸Šæµ·ä¹¦åŸ(ç¦å·è·¯åº—)"                        # å…´è¶£ç‚¹
}
```

#### æœºå™¨äººæ¶ˆæ¯

1. ä¸Šè¡Œæ¶ˆæ¯ï¼ˆç”¨æˆ·å‘ç»™æœºå™¨äººï¼‰
```json
{
  "body":"æœºå™¨äººä½ å¥½"
}
```

2. ä¸‹è¡Œæ¶ˆæ¯ï¼ˆæœºå™¨äººå›å¤ï¼‰
```json
{
  "body":"æœºå™¨äººä½ å¥½",                          # åŸå§‹æ–‡æœ¬æ•°æ®ï¼Œåœ¨UIä¸­å±•ç°
  "content":{
    "type":"text",                            # æœºå™¨äººå›ç­”ï¼Œæ–‡æœ¬æ¶ˆæ¯ï¼Œéœ€è¦é…åˆå‚æ•°content
    "content":"ä½ ä¹Ÿå¥½"
  }
}
```

### 2.3.5 æ‹‰æ¶ˆæ¯

#### 2.3.5.1 æœ€è¿‘èŠå¤©ä¼šè¯åˆ—è¡¨è¯·æ±‚

```protobuf
// æœ€è¿‘èŠå¤©ä¼šè¯åˆ—è¡¨è¯·æ±‚
message CIMRecentContactSessionReq {
  // cmd id:		0x0201
  required uint64 user_id = 1;
  required uint32 latest_update_time = 2; // æœ€åæ›´æ–°æ—¶é—´
}

// ä¼šè¯ä¿¡æ¯
message CIMContactSessionInfo {
  required uint64 session_id = 1;                   // ä¼šè¯id
  required CIMSessionType session_type = 2;         // ä¼šè¯ç±»å‹
  required CIMSessionStatusType session_status = 3; // ä¼šè¯ä¿®æ”¹å‘½ä»¤ï¼Œé¢„ç•™
  required uint32 unread_cnt = 4;     // è¯¥ä¼šè¯æœªè¯»æ¶ˆæ¯æ•°é‡
  required uint32 updated_time = 5;   // æ›´æ–°æ—¶é—´
  required string msg_id = 6;         // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„idï¼ˆUUIDï¼‰
  required uint64 msg_time_stamp = 7; // æœ€æ–°ä¸€æ¡æ¶ˆæ¯æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
  required bytes msg_data = 8;        // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„å†…å®¹
  required CIMMsgType msg_type = 9;   // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„ç±»å‹
  required uint64 msg_from_user_id = 10; // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„å‘é€è€…
  required CIMMessageStatus msg_status = 11; // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„çŠ¶æ€ï¼ˆé¢„ç•™ï¼‰
  optional string msg_attach = 12;  // æœ€æ–°ä¸€æ¡æ¶ˆæ¯çš„é™„ä»¶ï¼ˆé¢„ç•™ï¼‰
  optional string extend_data = 13; // æœ¬åœ°æ‰©å±•å­—æ®µï¼ˆé™åˆ¶4096ï¼‰
  optional bool is_robot_session = 14 [ default = false ]; // æ˜¯å¦ä¸ºæœºå™¨äººä¼šè¯
}

message CIMRecentContactSessionRsp {
  // cmd id:		0x0202
  required uint64 user_id = 1;
  required uint32 unread_counts = 2; // æ€»æœªè¯»æ•°é‡
  repeated CIM.Def.CIMContactSessionInfo contact_session_list = 3; // ä¼šè¯åˆ—è¡¨
}
```

#### 2.3.5.2 å†å²ç¦»çº¿æ¶ˆæ¯

```protobuf
message CIMGetMsgListReq {
  // cmd id:		0x0205
  required uint64 user_id = 1;
  required CIM.Def.CIMSessionType session_type = 2;
  required uint64 session_id = 3;
  required uint64 end_msg_id = 4; // ç»“æŸæœåŠ¡å™¨æ¶ˆæ¯id(ä¸åŒ…å«åœ¨æŸ¥è¯¢ç»“æœä¸­)
  required uint32 limit_count = 6; // æœ¬æ¬¡æŸ¥è¯¢æ¶ˆæ¯çš„æ¡æ•°ä¸Šçº¿(æœ€å¤š100æ¡)
}

// æ¶ˆæ¯ä¿¡æ¯
message CIMMsgInfo {
  required string client_msg_id = 1; // å®¢æˆ·ç«¯æ¶ˆæ¯IDï¼ˆUUIDï¼‰
  required uint64 server_msg_id = 2; // æœåŠ¡ç«¯æ¶ˆæ¯ID

  required CIMResCode msg_res_code = 3;       // æ¶ˆæ¯é”™è¯¯ç 
  required CIMMessageFeature msg_feature = 4; // æ¶ˆæ¯å±æ€§
  required CIMSessionType session_type = 5;   // ä¼šè¯ç±»å‹
  required uint64 from_user_id = 6;           // æ¥æºä¼šè¯ID
  required uint64 to_session_id = 7;          // ç›®æ ‡ä¼šè¯ID
  required uint64 create_time = 8; // æ¶ˆæ¯åˆ›å»ºæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰

  required CIMMsgType msg_type = 9;               // æ¶ˆæ¯ç±»å‹
  required CIMMessageStatus msg_status = 10;      // æ¶ˆæ¯çŠ¶æ€ï¼ˆé¢„ç•™ï¼‰
  required bytes msg_data = 11;                   // æ¶ˆæ¯å†…å®¹
  optional string attach = 12;                    // æ¶ˆæ¯é™„ä»¶ï¼ˆé¢„ç•™ï¼‰
  required CIMClientType sender_client_type = 13; // å‘é€è€…å®¢æˆ·ç«¯ç±»å‹
}

//å¯¹äºç¾¤è€Œè¨€ï¼Œå¦‚æœæ¶ˆæ¯æ•°ç›®è¿”å›çš„æ•°å€¼å°äºè¯·æ±‚çš„cnt,åˆ™è¡¨ç¤ºç¾¤çš„æ¶ˆæ¯èƒ½æ‹‰å–çš„åˆ°å¤´äº†ï¼Œæ›´æ—©çš„æ¶ˆæ¯æ²¡æœ‰æƒé™æ‹‰å–ã€‚
//å¦‚æœlimit_count å’Œ msg_list.count ä¸ä¸€è‡´ï¼Œè¯´æ˜æœåŠ¡å™¨æ¶ˆæ¯æœ‰ç¼ºå¤±ï¼Œéœ€è¦
//å®¢æˆ·ç«¯åšä¸€ä¸ªç¼ºå¤±æ ‡è®°ï¼Œé¿å…ä¸‹æ¬¡å†æ¬¡æ‹‰å–ã€‚
message CIMGetMsgListRsp {
  // cmd id:		0x0206
  required uint64 user_id = 1;
  required CIM.Def.CIMSessionType session_type = 2;
  required uint64 session_id = 3;
  repeated CIM.Def.CIMMsgInfo msg_list = 6; // æ¶ˆæ¯åˆ—è¡¨
}
```

# 3 å­˜å‚¨è®¾è®¡

## 3.1 mysql æ•°æ®åº“

MySQL æ•°æ®åº“é‡‡ç”¨ utf8mb4 ç¼–ç æ ¼å¼ï¼ˆemoji å­—ç¬¦é—®é¢˜ï¼‰
Encoding:UTF-8 Unicode(utf8mb4)
Collation:utf8mb4_general_ci

### 3.1.1 ä¼šè¯è¡¨

```sql
CREATE TABLE `im_session` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL COMMENT 'ç”¨æˆ·id',
  `peer_id` int(11) NOT NULL COMMENT 'å¯¹æ–¹idï¼Œå•èŠä»£è¡¨ç”¨æˆ·ï¼Œç¾¤èŠä»£è¡¨ç¾¤ç»„',
  `session_type` int(11) DEFAULT NULL COMMENT 'ä¼šè¯ç±»å‹ï¼Œ1ï¼šå•èŠï¼Œ2ï¼šç¾¤èŠ',
  `session_status` int(11) DEFAULT NULL COMMENT 'ä¼šè¯ä¿®æ”¹å‘½ä»¤ï¼ˆé¢„ç•™ï¼‰',
  `is_robot_session` tinyint(4) DEFAULT '0' COMMENT 'æ˜¯å¦ä¸ºæœºå™¨äººä¼šè¯ï¼Œ1æ˜¯ï¼Œ0å¦',
  `created` int(11) NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´æˆ³',
  `updated` int(11) NOT NULL COMMENT 'æ›´æ–°æ—¶é—´æˆ³',
  PRIMARY KEY (`id`),
  UNIQUE KEY `index` (`user_id`,`peer_id`),
  KEY `idx_userid_peerid_status` (`user_id`,`peer_id`,`session_status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.2 å‘é€æ¶ˆæ¯è¡¨

```sql
CREATE TABLE `im_message_send_0` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `msg_id` bigint(20) NOT NULL COMMENT 'æœåŠ¡ç«¯æ¶ˆæ¯ID',
  `client_msg_id` varchar(64) NOT NULL COMMENT 'å®¢æˆ·ç«¯æ¶ˆæ¯ID-UUID',
  `from_id` bigint(11) NOT NULL,
  `to_id` bigint(11) NOT NULL,
  `group_id` bigint(20) DEFAULT NULL,
  `msg_type` int(11) DEFAULT NULL,
  `msg_content` varchar(2048) DEFAULT NULL,
  `msg_res_code` tinyint(4) DEFAULT NULL COMMENT 'æ¶ˆæ¯é”™è¯¯ç  0ï¼šä¸€åˆ‡æ­£å¸¸',
  `msg_feature` tinyint(4) DEFAULT NULL COMMENT 'æ¶ˆæ¯å±æ€§ 0ï¼šé»˜è®¤ 1ï¼šç¦»çº¿æ¶ˆæ¯ 2ï¼šæ¼«æ¸¸æ¶ˆæ¯ 3ï¼šåŒæ­¥æ¶ˆæ¯ 4ï¼šé€ä¼ æ¶ˆæ¯',
  `msg_status` tinyint(4) DEFAULT '0' COMMENT 'æ¶ˆæ¯çŠ¶æ€ 0ï¼šé»˜è®¤ 1ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œæœªè¯» 2ï¼šæ”¶åˆ°æ¶ˆæ¯ï¼Œå·²è¯» 3ï¼šå·²åˆ  4ï¼šå‘é€ä¸­ 5ï¼šå·²å‘é€ 7ï¼šè‰ç¨¿ 8ï¼šå‘é€å–æ¶ˆ 9ï¼šè¢«å¯¹æ–¹æ‹’ç»ï¼Œå¦‚åœ¨é»‘åå•ä¸­',
  `created` int(11) DEFAULT NULL,
  `updated` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.3 æ¥æ”¶æ¶ˆæ¯è¡¨

```sql
CREATE TABLE `im_message_recv_3` (
  `msg_id` bigint(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'æ¶ˆæ¯id',
  `msg_from` varchar(32) NOT NULL DEFAULT '' COMMENT 'å‘é€è€…',
  `msg_to` varchar(32) NOT NULL DEFAULT '' COMMENT 'æ¥æ”¶è€…',
  `group_id` bigint(20) DEFAULT NULL COMMENT 'ç¾¤id',
  `cmd_id` int(11) DEFAULT NULL COMMENT 'tcpåŒ…å¤´å‘½ä»¤id',
  `msg_seq` int(11) DEFAULT NULL COMMENT 'tcpåŒ…å¤´åºåˆ—å·',
  `msg_content` varchar(2048) DEFAULT NULL COMMENT 'æ¶ˆæ¯å†…å®¹',
  `send_time` datetime DEFAULT NULL COMMENT 'æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯çš„æ—¶é—´',
  `msg_type` int(11) DEFAULT NULL COMMENT 'æ¶ˆæ¯ç±»å‹',
  `delivered` tinyint(4) DEFAULT '0' COMMENT '0ï¼šæœªé€è¾¾ï¼›1ï¼šé€è¾¾',
  PRIMARY KEY (`msg_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.4 ç¾¤ç»„è¡¨

```sql
CREATE TABLE `im_group` (
  `group_id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'ç¾¤ç»„id',
  `group_name` varchar(32) NOT NULL DEFAULT '' COMMENT 'ç¾¤å',
  `create_user_id` bigint(20) NOT NULL COMMENT 'åˆ›å»ºè€…id',
  `create_time` int(11) DEFAULT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
  `owner` bigint(20) NOT NULL COMMENT 'ç¾¤ä¸»',
  `announcement` varchar(1024) NOT NULL DEFAULT '' COMMENT 'ç¾¤å…¬å‘Š',
  PRIMARY KEY (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.5 ç¾¤æˆå‘˜è¡¨

```sql
CREATE TABLE `im_group_member` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
  `group_id` bigint(20) NOT NULL COMMENT 'ç¾¤ç»„id',
  `user_id` bigint(20) NOT NULL COMMENT 'ç”¨æˆ·id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 3.1.6 æ°´å¹³åˆ†åº“

| è¡¨å            | æè¿°           | æ‹†åˆ†æ–¹å¼                                | ä¸¾ä¾‹                                     |
| --------------- | -------------- | --------------------------------------- | ---------------------------------------- |
| im_message_send | ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ | æŒ‰ç…§ hash(msg_from)%4 å–æ¨¡ï¼Œæ‹†åˆ† 4 ä¸ªåº“ | im_message_send_0ã€â€¦â€¦ã€im_message_send_3 |
| im_message_recv | ç”¨æˆ·æ¥æ”¶çš„æ¶ˆæ¯ | æŒ‰ç…§ hash(msg_to)%4 å–æ¨¡ï¼Œæ‹†åˆ† 4 ä¸ªåº“   | im_message_recv_0ã€â€¦â€¦ã€im_message_recv_3 |

## 3.2 redis ç¼“å­˜
